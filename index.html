<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¢–ï–ü–õ–û</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            /* –¶–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞ */
            --bg-color: #f4f7fc;
            --card-bg: #ffffff;
            --text-main: #2d3436;
            --text-sec: #636e72;
            --primary: #6c5ce7; 
            --accent: #0984e3;
            --success: #00b894;
            --danger: #ff7675;
            --warning: #fdcb6e;
            
            /* –î–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º–∞ */
            --shadow: 0 10px 30px rgba(0,0,0,0.06), 0 2px 10px rgba(0,0,0,0.02);
            --radius: 24px;
            --font-main: 'Montserrat', sans-serif;
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --card-bg: #1e1e24;
            --text-main: #f5f6fa;
            --text-sec: #b2bec3;
            --primary: #a29bfe; 
            --shadow: 0 10px 40px rgba(0,0,0,0.4);
        }

        /* --- –ë–ê–ó–ê --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0; 
            padding: 0 0 calc(90px + var(--safe-area-bottom)) 0;
            background: var(--bg-color); 
            color: var(--text-main);
            font-family: var(--font-main); 
            transition: background 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        .hidden { display: none !important; }

        /* --- –¢–ò–ü–û–ì–†–ê–§–ò–ö–ê –ò –≠–õ–ï–ú–ï–ù–¢–´ --- */
        h2 { font-size: 1.2rem; margin: 0 0 15px 0; color: var(--primary); font-weight: 800; letter-spacing: -0.5px; }
        h3 { margin: 0; font-weight: 700; letter-spacing: -0.3px; }

        .card {
            background: var(--card-bg); border-radius: var(--radius);
            padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow);
            transition: 0.2s; position: relative; border: 1px solid rgba(0,0,0,0.02);
        }
        .card:active { transform: scale(0.995); }

        /* --- –ö–ù–û–ü–ö–ò –ò –ò–ù–ü–£–¢–´ (–ö–†–£–ü–ù–´–ï) --- */
        button { border: none; cursor: pointer; font-family: inherit; font-weight: 600; transition: 0.2s; }
        
        .btn {
            padding: 0 20px; height: 48px; border-radius: 16px;
            background: var(--bg-color); color: var(--text-main);
            box-shadow: var(--shadow); display: inline-flex; align-items: center; justify-content: center;
            font-size: 0.95rem;
        }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 8px 20px rgba(108, 92, 231, 0.3); }
        
        .btn-sm { height: 36px; padding: 0 14px; font-size: 0.8rem; border-radius: 12px; }
        .btn-circle { width: 44px; height: 44px; padding: 0; border-radius: 50%; font-size: 1.3rem; }
        .btn-toggle { background: transparent; padding: 5px 10px; color: var(--text-sec); font-size: 1.4rem; }
        
        /* –ö–Ω–æ–ø–∫–∞ –§–æ–∫—É—Å–∞ (–ê–Ω—Ç–∏–≤—ã–≥–æ—Ä–∞–Ω–∏–µ) */
        .btn-focus {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white; border-radius: 20px; padding: 6px 14px;
            font-size: 0.75rem; font-weight: bold; display: flex; align-items: center; gap: 6px;
            box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3); margin-right: 5px;
        }
        .btn-focus:active { transform: scale(0.95); }

        input, select {
            width: 100%; height: 48px; padding: 0 15px; border-radius: 14px; 
            border: 1px solid rgba(0,0,0,0.05); background: var(--bg-color); 
            color: var(--text-main); margin-bottom: 10px; font-size: 16px;
            font-family: inherit; transition: 0.2s;
        }
        input:focus, select:focus { border-color: var(--primary); background: var(--card-bg); }

        /* --- –•–ï–î–ï–† (–†–ê–ó–ú–´–¢–´–ô) --- */
        header {
            position: sticky; top: 0; z-index: 100; padding: 15px 20px;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
        }
        [data-theme="dark"] header { background: rgba(30, 30, 36, 0.9); }
        
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .logo { font-size: 1.5rem; font-weight: 900; letter-spacing: -1px; background: -webkit-linear-gradient(0deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .global-filter { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .filter-chip {
            white-space: nowrap; padding: 8px 16px; border-radius: 20px;
            background: var(--bg-color); font-size: 0.85rem; color: var(--text-sec); font-weight: 600;
            border: 1px solid transparent; transition: 0.2s; cursor: pointer;
        }
        .filter-chip.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(108, 92, 231, 0.2); }
        #custom-date-panel { display: flex; gap: 5px; margin-top: 10px; animation: fadeIn 0.3s; }

        /* --- –¢–ê–ë–´ –ò –ó–ê–î–ê–ß–ò --- */
        .tab-content { display: none; animation: fadeIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .task-item {
            background: var(--bg-color); border-radius: 18px; padding: 16px;
            margin-bottom: 12px; border-left: 5px solid transparent; transition: transform 0.1s;
        }
        input[type="checkbox"] { width: 24px !important; height: 24px !important; margin: 0; accent-color: var(--primary); cursor: pointer; }
        .recurring-badge { font-size: 0.6rem; background: var(--accent); color: white; padding: 3px 6px; border-radius: 6px; margin-left: 8px; font-weight: bold; }
        .subtasks-list { margin-top: 10px; padding-left: 12px; border-left: 2px solid rgba(0,0,0,0.05); }
        .subtask { display: flex; align-items: center; margin-top: 8px; font-size: 0.9rem; }

        /* --- –ö–û–®–ï–õ–ï–ö –ò –ú–ê–ì–ê–ó–ò–ù --- */
        .wallet-card { padding: 20px; border-radius: 20px; color: white; margin-bottom: 15px; position: relative; overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .wallet-inc { background: linear-gradient(135deg, #00b894, #00cec9); }
        .wallet-exp { background: linear-gradient(135deg, #ff7675, #d63031); }
        .history-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 0.95rem; }
        
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .shop-item {
            background: var(--card-bg); padding: 20px 15px; border-radius: 20px;
            display: flex; flex-direction: column; align-items: center; text-align: center;
            box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.05); position: relative;
        }
        .shop-icon { font-size: 3rem; margin-bottom: 10px; }
        .shop-price {
            background: var(--warning); color: #fff; padding: 5px 12px; border-radius: 10px;
            font-size: 0.85rem; font-weight: bold; margin-bottom: 10px;
            box-shadow: 0 4px 10px rgba(253, 203, 110, 0.4);
        }
        .btn-buy { width: 100%; padding: 10px; background: var(--bg-color); color: var(--text-main); border-radius: 12px; font-size: 0.85rem; font-weight: bold; }
        .btn-buy:active { background: var(--success); color: white; }
        .del-reward { position: absolute; top: 8px; right: 8px; color: var(--danger); opacity: 0.4; cursor: pointer; font-size: 1.2rem; font-weight: bold; padding: 5px; }
        .del-reward:hover { opacity: 1; }

        /* --- –ù–ê–í–ò–ì–ê–¶–ò–Ø (–°–¢–ï–ö–õ–û) --- */
        .nav-bar {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 92%; max-width: 450px;
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.5); border-radius: 35px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: flex; justify-content: space-around; padding: 12px 10px; z-index: 999;
        }
        [data-theme="dark"] .nav-bar { background: rgba(30, 30, 36, 0.85); border: 1px solid rgba(255,255,255,0.05); }

        .nav-item { opacity: 0.4; transition: 0.3s; display: flex; flex-direction: column; align-items: center; width: 60px; cursor: pointer; transform: scale(0.9); }
        .nav-item.active { opacity: 1; color: var(--primary); transform: scale(1) translateY(-2px); }

        /* --- –ú–û–î–ê–õ–ö–ò (–®–¢–û–†–ö–ò –°–ù–ò–ó–£) --- */
        .modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); 
            z-index: 2000; display: none; align-items: flex-end; justify-content: center;
        }
        .modal-content { 
            background: var(--card-bg); width: 100%; max-width: 600px;
            border-radius: 30px 30px 0 0; padding: 30px 25px 60px 25px; 
            max-height: 85vh; overflow-y: auto; box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
            transform: translateY(100%); animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
        @keyframes slideUp { to { transform: translateY(0); } }

        /* --- –ì–†–ê–§–ò–ö–ò, –¢–ê–ô–ú–ï–†, –ù–ê–°–¢–†–û–ï–ù–ò–ï --- */
        .chart-box { display: flex; align-items: flex-end; justify-content: space-between; height: 120px; gap: 4px; padding-top: 10px; }
        .bar-col { flex: 1; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; }
        .bar { width: 80%; border-radius: 6px 6px 0 0; min-height: 4px; }
        
        .pie-chart-container { display: flex; align-items: center; justify-content: space-around; padding: 10px 0; }
        .pie-chart { width: 120px; height: 120px; border-radius: 50%; box-shadow: inset 0 0 0 25px var(--card-bg); }
        .chart-legend { font-size: 0.8rem; display: flex; flex-direction: column; gap: 8px; }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-color { width: 12px; height: 12px; border-radius: 4px; }

        .timer-display { font-size: 5rem; font-weight: 900; color: var(--text-main); margin: 30px 0; font-variant-numeric: tabular-nums; line-height: 1; letter-spacing: -2px; }
        .timer-mode { background: rgba(0,0,0,0.05); padding: 6px 16px; border-radius: 20px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; color: var(--text-sec); display: inline-block; }
        .timer-controls { display: flex; gap: 15px; justify-content: center; width: 100%; margin-top: 30px; }
        .mode-work .timer-display { color: var(--primary); }
        .mode-rest .timer-display { color: var(--success); }

        .mood-grid { display: flex; justify-content: space-between; margin-top: 15px; background: var(--bg-color); padding: 10px; border-radius: 20px; }
        .mood-btn { font-size: 2rem; background: transparent; border: none; cursor: pointer; opacity: 0.4; transition: 0.2s; transform: scale(0.9); padding: 0; }
        .mood-btn.selected { opacity: 1; transform: scale(1.2); filter: drop-shadow(0 0 10px rgba(0,0,0,0.1)); }
        /* --- –ñ–ò–í–û–ï –°–ï–†–î–¶–ï (BLOB) --- */
        /* --- LIVING BLOB 2.0 (–ñ–∏–¥–∫–∏–π –∏ –£–º–Ω—ã–π) --- */
        .living-blob {
            width: 32px; height: 32px; 
            border-radius: 50%;
            margin-right: auto; margin-left: 15px;
            transition: all 0.5s ease;
            position: relative;
            
            /* –ë–∞–∑–æ–≤–∞—è "–∂–∏–¥–∫–∞—è" –∞–Ω–∏–º–∞—Ü–∏—è */
            animation: liquid 5s infinite ease-in-out;
        }

        /* 1. –≠–§–§–ï–ö–¢ "–©–ò–¢" (–§–æ–∫—É—Å) - –î–≤–æ–π–Ω–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ */
        .blob-shield {
            background: var(--primary) !important;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.5), 0 0 15px var(--primary);
            animation: pulseShield 2s infinite !important;
        }

        /* 2. –≠–§–§–ï–ö–¢ "–¢–†–ï–í–û–ì–ê" (–†–∞—Å—Ö–æ–¥—ã) - –¢—Ä—è—Å–∫–∞ –∏ –∫—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç */
        .blob-panic {
            background: var(--danger) !important;
            box-shadow: 0 0 10px var(--danger);
            animation: shake 0.5s infinite !important;
        }

        /* 3. –≠–§–§–ï–ö–¢ "–î–ï–ü–†–ï–°–°–ò–Ø" (–ü–ª–æ—Ö–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ) - –°–µ—Ä—ã–π –∏ –º–µ–¥–ª–µ–Ω–Ω—ã–π */
        .blob-sad {
            filter: grayscale(1) opacity(0.6);
            transform: scale(0.8);
            animation-duration: 10s !important; /* –û—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ */
        }

        /* 4. –≠–§–§–ï–ö–¢ "–ú–û–©–¨" (–ú–Ω–æ–≥–æ –±–∞–ª–ª–æ–≤) - –ë–æ–ª—å—à–æ–π –∏ —è—Ä–∫–∏–π */
        .blob-power {
            filter: brightness(1.3) drop-shadow(0 0 8px currentColor);
            transform: scale(1.2);
            animation-duration: 2s !important; /* –ë—ã—Å—Ç—Ä–æ */
        }

        /* --- –ê–ù–ò–ú–ê–¶–ò–ò --- */
        @keyframes liquid {
            0% { border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; }
            50% { border-radius: 30% 60% 70% 40% / 50% 60% 30% 60%; }
            100% { border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; }
        }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        @keyframes pulseShield {
            0% { box-shadow: 0 0 0 0 rgba(108, 92, 231, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(108, 92, 231, 0); }
            100% { box-shadow: 0 0 0 0 rgba(108, 92, 231, 0); }
        }

        /* --- –ß–ï–ö –î–ù–Ø (RECEIPT) --- */
        .receipt-paper {
            background: #fff; padding: 25px; margin-bottom: 20px;
            font-family: 'Courier New', Courier, monospace; /* –®—Ä–∏—Ñ—Ç –∫–∞–∫ –≤ —á–µ–∫–µ */
            color: #333; position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            /* –ó—É–±—á–∏–∫–∏ —á–µ–∫–∞ —á–µ—Ä–µ–∑ –≥—Ä–∞–¥–∏–µ–Ω—Ç - —Å–µ–Ω—å–æ—Ä—Å–∫–∏–π —Ç—Ä—é–∫ */
            background-image: linear-gradient(135deg, transparent 50%, #fff 50%), linear-gradient(45deg, transparent 50%, #fff 50%);
            background-position: top; background-size: 15px 15px; background-repeat: repeat-x;
        }
        .receipt-header { text-align: center; border-bottom: 2px dashed #333; padding-bottom: 15px; margin-bottom: 15px; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
        .receipt-total { border-top: 2px dashed #333; padding-top: 10px; margin-top: 10px; font-weight: 900; font-size: 1.2rem; display: flex; justify-content: space-between; }
        .receipt-footer { text-align: center; margin-top: 20px; font-size: 0.7rem; opacity: 0.6; }
        /* --- –ú–ò–ù–ò –¢–ê–ô–ú–ï–† –ò –°–í–û–†–ê–ß–ò–í–ê–ù–ò–ï --- */
        .mini-timer {
            position: fixed; bottom: 100px; left: 5%; width: 90%;
            background: rgba(30, 30, 36, 0.95); backdrop-filter: blur(10px);
            color: white; padding: 15px 20px; border-radius: 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4); z-index: 1500;
            cursor: pointer; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255,255,255,0.15);
            animation: slideUp 0.3s forwards;
        }
        .mini-timer:active { transform: scale(0.95); }
        
        /* –°—Ç—Ä–µ–ª–∫–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏ */
        .minimize-btn {
            position: absolute; top: 15px; right: 20px; 
            font-size: 2rem; opacity: 0.5; cursor: pointer;
            width: 40px; height: 40px; line-height: 40px;
            text-align: center; border-radius: 50%;
            background: rgba(0,0,0,0.05);
        }
    </style>
</head>
<body data-theme="light">

<header>
    <div class="header-top">
        <div class="logo">–¢–ï–ü–õ–û</div>
        
        <div id="blob" class="living-blob blob-calm" title="–ü—É–ª—å—Å —Ç–≤–æ–µ–≥–æ –¥–Ω—è"></div>

        <div style="display: flex; gap: 8px;">
            <button class="btn btn-circle" onclick="app.receipt.open()" style="font-size: 1.1rem;">üßæ</button>
            <button class="btn btn-circle" onclick="app.ui.modal('achievements')" style="color: #f1c40f;">üèÜ</button>
            <button class="btn btn-circle" onclick="app.ui.modal('settings')">‚öôÔ∏è</button>
        </div>
    </div>
    
    <div class="global-filter">
        <div class="filter-chip active" onclick="app.ui.setFilter('today', this)">–°–µ–≥–æ–¥–Ω—è</div>
        <div class="filter-chip" onclick="app.ui.setFilter('week', this)">–ù–µ–¥–µ–ª—è</div>
        <div class="filter-chip" onclick="app.ui.setFilter('month', this)">–ú–µ—Å—è—Ü</div>
        <div class="filter-chip" onclick="app.ui.setFilter('all', this)">–í—Å–µ –≤—Ä–µ–º—è</div>
        <div class="filter-chip" style="border: 1px dashed var(--primary)" onclick="app.ui.toggleCustomDate()">üìÖ –í—ã–±—Ä–∞—Ç—å</div>
    </div>
    <div id="custom-date-panel" class="hidden">
        <input type="date" id="date-start" onchange="app.ui.setFilter('custom')">
        <input type="date" id="date-end" onchange="app.ui.setFilter('custom')">
    </div>
    <div style="text-align: center; font-size: 0.75rem; margin-top: 5px; color: var(--text-sec)" id="current-range-label"></div>
</header>

<div id="tab-stats" class="container tab-content active">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <h3>üå° –ö–∞–∫ —Ç—ã —Å–µ–≥–æ–¥–Ω—è?</h3>
            <small id="mood-date" style="color:var(--text-sec)">–°–µ–≥–æ–¥–Ω—è</small>
        </div>
        <div class="mood-grid" id="mood-container">
            </div>
    </div>
    <div class="card" style="background: linear-gradient(135deg, #a29bfe, #6c5ce7); color: white;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 style="opacity: 0.9">–°–µ—Ä–∏—è (Streak)</h3>
                <div style="font-size: 2.2rem; font-weight: 900;" id="streak-val">0</div>
                <small>–¥–Ω–µ–π –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤</small>
            </div>
            <div style="font-size: 2.5rem">üî•</div>
        </div>
    </div>
    
    <div class="card">
        <h2>‚ö° –≠–Ω–µ—Ä–≥–∏—è</h2>
        <div class="chart-box" id="chart-energy" style="height: 150px;"></div>
        <div style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.05);">
            <div style="font-size: 0.8rem; color: var(--text-sec); text-transform: uppercase; letter-spacing: 1px;">–ù–∞–±—Ä–∞–Ω–æ –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
            <div id="total-points-display" style="font-size: 2rem; font-weight: 900; color: var(--primary); margin: 5px 0;">0</div>
        </div>
    </div>

    <div class="card">
        <h2>üìä –§–∏–Ω–∞–Ω—Å—ã (<span class="curr"></span>)</h2>
        <div class="chart-box" id="chart-finance" style="height: 150px;"></div>
        <div style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.05);">
            <div style="font-size: 0.8rem; color: var(--text-sec); text-transform: uppercase; letter-spacing: 1px;">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</div>
            <div id="balance-display" style="font-size: 2rem; font-weight: 900; color: var(--text-main); margin: 5px 0;">0</div>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 0 20px; font-size: 0.9rem;">
            <div style="color: var(--success); font-weight: 600;">‚ñº <span id="stat-inc">0</span></div>
            <div style="color: var(--danger); font-weight: 600;">‚ñ≤ <span id="stat-exp">0</span></div>
        </div>
    </div>
    <div class="card">
        <h2>üç∞ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤</h2>
        <div id="expense-pie-chart-wrapper" style="text-align: center; color: var(--text-sec); padding: 20px;">
            –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥
        </div>
    </div>
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h2>üéØ –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ü–µ–ª–∏</h2>
            <button class="btn btn-sm btn-primary" onclick="app.ui.modal('add-goal')">+ –¶–µ–ª—å</button>
        </div>
        <div id="goals-list"></div>
    </div>
</div>

<div id="tab-tasks" class="container tab-content">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <button class="btn btn-circle" onclick="app.tasks.nav(-1)">‚óÄ</button>
            <h3 id="task-date-label">–°–µ–≥–æ–¥–Ω—è</h3>
            <button class="btn btn-circle" onclick="app.tasks.nav(1)">‚ñ∂</button>
        </div>
        <input type="text" id="task-input" placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞..." onkeypress="if(event.key==='Enter') app.tasks.add()">
        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
            <select id="task-cat" style="flex: 1; margin: 0;">
                <option value="–†–∞–±–æ—Ç–∞">üíº –†–∞–±–æ—Ç–∞</option>
                <option value="–¢–µ–ª–æ">üí™ –¢–µ–ª–æ</option>
                <option value="–§–æ–∫—É—Å">üß† –§–æ–∫—É—Å</option>
                <option value="–ë—ã—Ç">üè† –ë—ã—Ç</option>
            </select>
            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.8rem; cursor: pointer;">
                <input type="checkbox" id="task-recur" style="width: auto; margin: 0;"> –ü–æ–≤—Ç–æ—Ä—è—Ç—å
            </label>
        </div>
        <button class="btn btn-primary" style="width: 100%" onclick="app.tasks.add()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <div id="tasks-container"></div>
</div>

<div id="tab-wallet" class="container tab-content">
    <div class="wallet-card wallet-inc">
        <h3>üí∞ –î–æ—Ö–æ–¥</h3>
        <div style="margin-top: 10px; display: flex; gap: 5px;">
            <input type="number" id="inc-sum" placeholder="0.00" style="background: rgba(255,255,255,0.2); color: white; border: none; margin: 0;">
            <button class="btn" style="background: white; color: var(--success);" onclick="app.finance.add('income')">OK</button>
        </div>
        <select id="inc-cat" style="margin-top: 5px; background: rgba(255,255,255,0.2); color: white; border: none;">
            <option style="color:black" value="–ó–∞—Ä–ø–ª–∞—Ç–∞">–ó–∞—Ä–ø–ª–∞—Ç–∞</option>
            <option style="color:black" value="–§—Ä–∏–ª–∞–Ω—Å">–§—Ä–∏–ª–∞–Ω—Å</option>
            <option style="color:black" value="–ü–µ—Ä–µ–≤–æ–¥">–ü–µ—Ä–µ–≤–æ–¥</option>
            <option style="color:black" value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
        </select>
    </div>
    
    <div class="wallet-card wallet-exp">
        <h3>üí∏ –†–∞—Å—Ö–æ–¥</h3>
        <div style="margin-top: 10px; display: flex; gap: 5px;">
            <input type="number" id="exp-sum" placeholder="0.00" style="background: rgba(255,255,255,0.2); color: white; border: none; margin: 0;">
            <button class="btn" style="background: white; color: var(--danger);" onclick="app.finance.add('expense')">OK</button>
        </div>
        <select id="exp-cat" style="margin-top: 5px; background: rgba(255,255,255,0.2); color: white; border: none;">
            <option style="color:black" value="–ï–¥–∞">–ï–¥–∞</option>
            <option style="color:black" value="–°–∏–≥–∞—Ä–µ—Ç—ã">üö¨ –°–∏–≥–∞—Ä–µ—Ç—ã</option>
            <option style="color:black" value="–ö–≤–∞—Ä—Ç–∏—Ä–∞">–ö–≤–∞—Ä—Ç–∏—Ä–∞</option>
            <option style="color:black" value="–î–æ—Å—É–≥">–î–æ—Å—É–≥</option>
            <option style="color:black" value="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>
            <option style="color:black" value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
        </select>
    </div>

    <div class="card" style="margin-top: 20px;">
        <div class="wallet-controls" style="display: flex; flex-direction: column; gap: 10px;">
            <div style="display: flex; gap: 10px;">
                <select id="wallet-sort" class="sort-select" onchange="app.ui.renderWallet()">
                    <option value="date-desc">üìÖ –ù–æ–≤—ã–µ</option>
                    <option value="date-asc">üìÖ –°—Ç–∞—Ä—ã–µ</option>
                    <option value="amount-desc">üíé –î–æ—Ä–æ–≥–∏–µ</option>
                    <option value="amount-asc">üíé –î–µ—à–µ–≤—ã–µ</option>
                </select>
                <select id="wallet-filter-type" class="sort-select" onchange="app.ui.renderWallet()">
                    <option value="all">–í—Å–µ —Ç–∏–ø—ã</option>
                    <option value="income">üí∞ –î–æ—Ö–æ–¥—ã</option>
                    <option value="expense">üí∏ –†–∞—Å—Ö–æ–¥—ã</option>
                </select>
            </div>

            <select id="wallet-filter-cat" class="sort-select" style="width: 100%;" onchange="app.ui.renderWallet()">
                <option value="all">üìÇ –í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                <option disabled>‚îÄ‚îÄ –†–∞—Å—Ö–æ–¥—ã ‚îÄ‚îÄ</option>
                <option value="–ï–¥–∞">–ï–¥–∞</option>
                <option value="–°–∏–≥–∞—Ä–µ—Ç—ã">üö¨ –°–∏–≥–∞—Ä–µ—Ç—ã</option>
                <option value="–ö–≤–∞—Ä—Ç–∏—Ä–∞">–ö–≤–∞—Ä—Ç–∏—Ä–∞</option>
                <option value="–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è">–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
                <option value="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>
                <option value="–ó–¥–æ—Ä–æ–≤—å–µ">–ó–¥–æ—Ä–æ–≤—å–µ</option>
                <option value="–î–æ—Å—É–≥">–î–æ—Å—É–≥</option>
                <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                <option disabled>‚îÄ‚îÄ –î–æ—Ö–æ–¥—ã ‚îÄ‚îÄ</option>
                <option value="–ó–∞—Ä–ø–ª–∞—Ç–∞">–ó–∞—Ä–ø–ª–∞—Ç–∞</option>
                <option value="–§—Ä–∏–ª–∞–Ω—Å">–§—Ä–∏–ª–∞–Ω—Å</option>
                <option value="–ü–µ—Ä–µ–≤–æ–¥">–ü–µ—Ä–µ–≤–æ–¥</option>
                <option value="–ü–æ–¥–∞—Ä–æ–∫">–ü–æ–¥–∞—Ä–æ–∫</option>
            </select>
        </div>
        
        <h3>–ò—Å—Ç–æ—Ä–∏—è –∑–∞ –ø–µ—Ä–∏–æ–¥</h3>
        <div id="wallet-history"></div>
    </div>
</div>

<div id="tab-shop" class="container tab-content">
    <div class="card" style="background: linear-gradient(135deg, #f1c40f, #f39c12); color: white; text-align: center;">
        <h3 style="opacity:0.9">–î–æ—Å—Ç—É–ø–Ω–æ –±–∞–ª–ª–æ–≤</h3>
        <div style="font-size: 3rem; font-weight: 900;" id="shop-balance">0</div>
        <small>–¢—Ä–∞—Ç—å —Å —É–º–æ–º!</small>
    </div>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2>üõç –í–∏—Ç—Ä–∏–Ω–∞</h2>
            <button class="btn btn-sm" onclick="app.ui.modal('add-reward')">+ –¢–æ–≤–∞—Ä</button>
        </div>
        <div id="shop-list" class="shop-grid"></div>
    </div>
</div>
<nav class="nav-bar">
    <div class="nav-item active" onclick="app.ui.tab('stats', this)">
        <div style="font-size: 1.2rem;">üìä</div><div style="font-size: 0.7rem;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
    </div>
    <div class="nav-item" onclick="app.ui.tab('tasks', this)">
        <div style="font-size: 1.2rem;">üéØ</div><div style="font-size: 0.7rem;">–ó–∞–¥–∞—á–∏</div>
    </div>
    <div class="nav-item" onclick="app.ui.tab('wallet', this)">
        <div style="font-size: 1.2rem;">üëõ</div><div style="font-size: 0.7rem;">–ö–æ—à–µ–ª–µ–∫</div>
    </div>
    <div class="nav-item" onclick="app.ui.tab('shop', this)">
        <div style="font-size: 1.2rem;">üõí</div><div style="font-size: 0.7rem;">–ú–∞–≥–∞–∑–∏–Ω</div>
    </div>
</nav>

<div id="modal-settings" class="modal" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal-content">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <label>–í–∞–ª—é—Ç–∞:</label>
        <select id="sets-curr" onchange="app.settings.save()">
            <option value="USD">USD ($)</option>
            <option value="EUR">EUR (‚Ç¨)</option>
            <option value="RUB">RUB (‚ÇΩ)</option>
            <option value="GEL">GEL (‚Çæ)</option>
        </select>
        <button class="btn" style="width:100%; margin-top:10px;" onclick="app.ui.theme()">üåì –¢–µ–º–∞</button>
        <br><br>
        <button class="btn" style="width:100%; color:red" onclick="app.data.wipe()">–°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö</button>
    </div>
</div>

<div id="modal-add-goal" class="modal" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal-content">
        <h2>–ù–æ–≤–∞—è —Ü–µ–ª—å</h2>
        <input type="text" id="goal-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        <select id="goal-type" onchange="document.getElementById('goal-fin-opts').style.display = this.value==='finance'?'block':'none'">
            <option value="custom">–°–ø–∏—Å–æ—á–Ω–∞—è (—à–∞–≥–∏)</option>
            <option value="finance">–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è (–¥–æ—Ö–æ–¥)</option>
        </select>
        <div id="goal-fin-opts" style="display:none">
            <input type="number" id="goal-target" placeholder="–¶–µ–ª—å –¥–æ—Ö–æ–¥–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥">
        </div>
        <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="app.goals.add()">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
</div>
<div id="modal-add-reward" class="modal" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal-content">
        <h2>–ù–æ–≤–∞—è –Ω–∞–≥—Ä–∞–¥–∞</h2>
        <input type="text" id="reward-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. –ö–æ—Ñ–µ)">
        <input type="text" id="reward-icon" placeholder="–°–º–∞–π–ª–∏–∫ (–Ω–∞–ø—Ä. ‚òï)">
        <input type="number" id="reward-cost" placeholder="–¶–µ–Ω–∞ –≤ –±–∞–ª–ª–∞—Ö">
        <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="app.shop.add()">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≤–∏—Ç—Ä–∏–Ω—É</button>
    </div>
</div>
<div id="modal-achievements" class="modal" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal-content">
        <h2>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
        <div id="ach-container" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;"></div>
    </div>
</div>
<div id="modal-timer" class="modal" style="z-index: 3000;">
    <div class="modal-content" style="text-align: center;">
        <div class="minimize-btn" onclick="event.stopPropagation(); app.timer.minimize()">‚åÑ</div>

        <div id="timer-mode-badge" class="timer-mode">–§–æ–∫—É—Å</div>
        <h2 id="timer-task-name" style="margin: 15px 0 5px; font-size: 1.2rem;">–ó–∞–¥–∞—á–∞</h2>
        
        <div id="timer-container" class="mode-work">
            <div class="timer-display" id="timer-val">40:00</div>
        </div>
        
        <p style="font-size: 0.8rem; opacity: 0.6; margin: 0;">–ù–µ –æ—Ç–≤–ª–µ–∫–∞–π—Å—è. –¢—ã —Å–º–æ–∂–µ—à—å!</p>

        <div class="timer-controls">
            <button class="btn" style="background: var(--bg-color); color: var(--text-sec)" onclick="app.timer.cancel()">–ó–∞–∫—Ä—ã—Ç—å</button>
            <button class="btn btn-primary" id="timer-btn" onclick="app.timer.toggle()">–°—Ç–∞—Ä—Ç</button>
        </div>
        
        <button id="btn-rest" class="btn" style="width:100%; margin-top:15px; background:var(--success); color:white; display:none" onclick="app.timer.startRest()">‚òï –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ç–¥—ã—Ö—É (15 –º–∏–Ω)</button>
    </div>
</div>
<div id="mini-timer" class="mini-timer" onclick="app.timer.maximize()" style="display: none;">
    <div style="display:flex; align-items:center; gap:15px;">
        <span id="mini-timer-icon" style="font-size: 1.5rem;">üçÖ</span>
        <div>
            <div id="mini-timer-val" style="font-weight:900; font-family:monospace; font-size:1.4rem; line-height:1;">00:00</div>
            <div style="font-size:0.7rem; opacity:0.7">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å</div>
        </div>
    </div>
    <div style="font-size:1.5rem;">‚åÉ</div>
</div>
<div id="modal-receipt" class="modal" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal-content" style="background: var(--bg-color);"> <div id="receipt-content"></div> <button class="btn btn-primary" style="width:100%" onclick="document.getElementById('modal-receipt').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>
<script>
const app = {
    state: {
        finances: [],
        tasks: {},
        recurring: [],
        goals: [],
        rewards: [], 
        spent: 0,
        achievements: {},
        moods: {}, // –î–æ–±–∞–≤–∏–ª–∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
        settings: { currency: 'USD', theme: 'light' },
        filter: { start: '', end: '', mode: 'today' }
    },
    // --- –ê–£–î–ò–û –î–í–ò–ñ–û–ö (–°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä –∑–≤—É–∫–æ–≤) ---
    audio: {
        ctx: null,
        init() { if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
        play(type) {
            this.init();
            if(this.ctx.state === 'suspended') this.ctx.resume();
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain); gain.connect(this.ctx.destination);
            const now = this.ctx.currentTime;

            if (type === 'success') { // –ú–∞–∂–æ—Ä–Ω—ã–π "–î–∑—ã–Ω—å!"
                osc.type = 'sine';
                osc.frequency.setValueAtTime(523.25, now);
                osc.frequency.exponentialRampToValueAtTime(1046.5, now + 0.1);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } 
            else if (type === 'click') { // –ú—è–≥–∫–∏–π –∫–ª–∏–∫
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, now);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                osc.start(now); osc.stop(now + 0.05);
            }
            else if (type === 'error') { // –ì–ª—É—Ö–æ–π –∑–≤—É–∫
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            }
        }
    },

    // --- –ì–ï–ù–ï–†–ê–¢–û–† –ß–ï–ö–ê –î–ù–Ø ---
    receipt: {
        open() {
            const date = app.viewDate;
            const tasks = (app.state.tasks[date] || []).filter(t => t.done);
            const fins = app.state.finances.filter(f => f.date === date);
            
            const totalPoints = tasks.reduce((a,b)=>a+b.points,0);
            const inc = fins.filter(f=>f.type==='income').reduce((a,b)=>a+b.amount,0);
            const exp = fins.filter(f=>f.type==='expense').reduce((a,b)=>a+b.amount,0);
            const mood = app.state.moods[date] || 3;
            const moodIcon = ['üíÄ','üò´','üòï','üòê','üôÇ','ü§©'][mood] || 'üòê';

            let taskList = tasks.map(t => 
                `<div class="receipt-row"><span>${t.text.slice(0,20)}...</span><span>${t.points}–±</span></div>`
            ).join('');
            
            if(tasks.length === 0) taskList = '<div style="text-align:center; margin:10px 0;">–ù–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á</div>';

            const html = `
                <div class="receipt-paper">
                    <div class="receipt-header">
                        <h3>–¢–ï–ü–õ–û OS</h3>
                        <small>${date} ‚Ä¢ ${new Date().toLocaleTimeString()}</small><br>
                        <div style="font-size: 2rem; margin-top: 10px;">${moodIcon}</div>
                    </div>
                    
                    <div style="text-transform: uppercase; font-weight:bold; margin-bottom:10px; border-bottom:1px solid #eee">–ó–∞–¥–∞—á–∏</div>
                    ${taskList}
                    
                    <div style="text-transform: uppercase; font-weight:bold; margin:15px 0 10px; border-bottom:1px solid #eee">–§–∏–Ω–∞–Ω—Å—ã</div>
                    <div class="receipt-row"><span>–î–æ—Ö–æ–¥</span><span>+${inc}</span></div>
                    <div class="receipt-row"><span>–†–∞—Å—Ö–æ–¥</span><span>-${exp}</span></div>
                    
                    <div class="receipt-total">
                        <span>–ò–¢–û–ì–û –≠–ù–ï–†–ì–ò–ò:</span>
                        <span>${totalPoints} ‚ö°</span>
                    </div>
                    
                    <div class="receipt-footer">
                        –°–ü–ê–°–ò–ë–û, –ß–¢–û –ñ–ò–í–ï–®–¨ –≠–¢–£ –ñ–ò–ó–ù–¨<br>
                        –°–æ—Ö—Ä–∞–Ω–∏ —ç—Ç–æ—Ç —á–µ–∫ –Ω–∞ –ø–∞–º—è—Ç—å
                    </div>
                </div>
            `;
            document.getElementById('receipt-content').innerHTML = html;
            document.getElementById('modal-receipt').style.display = 'flex';
            app.audio.play('click');
        }
    },
    
    viewDate: new Date().toISOString().split('T')[0],
    rates: { 'USD': 1, 'EUR': 0.92, 'GEL': 2.75, 'RUB': 90 },
    syms: { 'USD': '$', 'EUR': '‚Ç¨', 'GEL': '‚Çæ', 'RUB': '‚ÇΩ' },

    init() {
        this.data.load();
        this.ui.setFilter('today', document.querySelector('.filter-chip.active'));
        this.achievements.gen();
        document.body.setAttribute('data-theme', this.state.settings.theme);
    },

    data: {
        save() { localStorage.setItem('teplo_final', JSON.stringify(app.state)); app.ui.updateAll(); },
        load() { 
            const d = localStorage.getItem('teplo_final'); 
            if(d) {
                const parsed = JSON.parse(d);
                app.state = {...app.state, ...parsed};
                if(!app.state.rewards) app.state.rewards = [];
                if(!app.state.spent) app.state.spent = 0;
                if(!app.state.moods) app.state.moods = {};
            }
            document.getElementById('sets-curr').value = app.state.settings.currency;
        },
        wipe() { if(confirm('–°–±—Ä–æ—Å–∏—Ç—å?')) { localStorage.removeItem('teplo_final'); location.reload(); } }
    },

    filter: {
        calc(mode) {
            const today = new Date();
            let start = new Date(), end = new Date();
            if (mode === 'today') { /* today */ }
            else if (mode === 'week') { start.setDate(today.getDate() - 6); }
            else if (mode === 'month') { start.setDate(today.getDate() - 29); }
            else if (mode === 'all') { start = new Date('2024-01-01'); }
            else if (mode === 'custom') {
                const s = document.getElementById('date-start').value;
                const e = document.getElementById('date-end').value;
                if(s) start = new Date(s); if(e) end = new Date(e);
            }
            app.state.filter = { start: start.toISOString().split('T')[0], end: end.toISOString().split('T')[0], mode };
            const l = document.getElementById('current-range-label');
            if(l) l.innerText = `${app.state.filter.start} ‚Äî ${app.state.filter.end}`;
        },
        inRange(d) { return d >= app.state.filter.start && d <= app.state.filter.end; }
    },

    finance: {
        add(type) {
            const s = document.getElementById(type==='income'?'inc-sum':'exp-sum');
            const c = document.getElementById(type==='income'?'inc-cat':'exp-cat');
            const val = parseFloat(s.value);
            if(!val) return;
            app.state.finances.push({
                id: Date.now(), date: new Date().toISOString().split('T')[0],
                type, amount: val, cat: c.value, curr: app.state.settings.currency
            });
            s.value = '';
            app.data.save();
        },
        getFiltered() { return app.state.finances.filter(f => app.filter.inRange(f.date)); }
    },

    // –ú–ê–ì–ê–ó–ò–ù (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —Ç–∞–π–º–µ—Ä —É–±—Ä–∞–Ω –æ—Ç—Å—é–¥–∞)
    // 1. –ë–õ–û–ö –ù–ê–°–¢–†–û–ï–ù–ò–Ø (–ù–û–í–´–ô)
    mood: {
        options: [{v:1,i:'üò´'},{v:2,i:'üòï'},{v:3,i:'üòê'},{v:4,i:'üôÇ'},{v:5,i:'ü§©'}],
        set(val) {
            const date = new Date().toISOString().split('T')[0];
            app.state.moods[date] = val;
            app.data.save();
            app.audio.play('click');
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–ª–æ–± —Å—Ä–∞–∑—É –ø—Ä–∏ –∫–ª–∏–∫–µ
            app.ui.renderBlob(); 
        },
        render() {
            const c = document.getElementById('mood-container');
            if(!c) return;
            c.innerHTML = '';
            const date = new Date().toISOString().split('T')[0];
            const current = app.state.moods[date];
            this.options.forEach(opt => {
                const isSel = current === opt.v;
                c.innerHTML += `<button class="mood-btn ${isSel?'selected':''}" onclick="app.mood.set(${opt.v})">${opt.i}</button>`;
            });
        }
    },

    // 2. –ë–õ–û–ö –ú–ê–ì–ê–ó–ò–ù–ê (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô - –ë–ï–ó –¢–ê–ô–ú–ï–†–ê)
    shop: {
        add() {
            const t = document.getElementById('reward-title').value;
            const i = document.getElementById('reward-icon').value || 'üéÅ';
            const c = parseInt(document.getElementById('reward-cost').value);
            if(!t || !c) return alert('–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ');
            app.state.rewards.push({ id: Date.now(), title: t, icon: i, cost: c });
            document.getElementById('modal-add-reward').style.display = 'none';
            app.data.save();
        },
        buy(id) {
            const r = app.state.rewards.find(x => x.id === id);
            const balance = app.ui.calcTotalPoints() - app.state.spent;
            if(balance >= r.cost) {
                if(confirm(`–ö—É–ø–∏—Ç—å "${r.title}"?`)) {
                    app.state.spent += r.cost;
                    app.data.save();
                    alert(`–ö—É–ø–ª–µ–Ω–æ: ${r.title}`);
                }
            } else alert('–ú–∞–ª–æ —ç–Ω–µ—Ä–≥–∏–∏!');
        },
        del(id) {
            if(confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) {
                app.state.rewards = app.state.rewards.filter(x => x.id !== id);
                app.data.save();
            }
        },
        render() {
            const c = document.getElementById('shop-list'); c.innerHTML = '';
            const bal = app.ui.calcTotalPoints() - app.state.spent;
            document.getElementById('shop-balance').innerText = bal;
            if(app.state.rewards.length === 0) { c.innerHTML = '<div style="grid-column:1/-1; opacity:0.5; text-align:center">–ü—É—Å—Ç–æ</div>'; return; }
            app.state.rewards.forEach(r => {
                const can = bal >= r.cost;
                c.innerHTML += `
                    <div class="shop-item" style="opacity:${can?1:0.7}">
                        <div class="del-reward" onclick="event.stopPropagation(); app.shop.del(${r.id})">√ó</div>
                        <div class="shop-icon">${r.icon}</div>
                        <div class="shop-price">${r.cost} ‚ö°</div>
                        <div style="font-weight:600; font-size:0.9rem; margin-bottom:8px">${r.title}</div>
                        <button class="btn-buy" onclick="app.shop.buy(${r.id})" style="background:${can?'var(--bg-color)':'#eee'}">${can?'–ö—É–ø–∏—Ç—å':'–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç'}</button>
                    </div>`;
            });
        }
    },
    audio: {
        ctx: new (window.AudioContext || window.webkitAudioContext)(),
        
        play(type) {
            if(this.ctx.state === 'suspended') this.ctx.resume();
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain);
            gain.connect(this.ctx.destination);

            const now = this.ctx.currentTime;
            
            if (type === 'success') {
                // –ü—Ä–∏—è—Ç–Ω—ã–π "–î–∑—ã–Ω—å!" (–º–∞–∂–æ—Ä–Ω—ã–π –∞–∫–∫–æ—Ä–¥)
                osc.type = 'sine';
                osc.frequency.setValueAtTime(523.25, now); // C5
                osc.frequency.exponentialRampToValueAtTime(1046.5, now + 0.1); // C6
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } 
            else if (type === 'click') {
                // –õ–µ–≥–∫–∏–π —â–µ–ª—á–æ–∫
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                osc.start(now);
                osc.stop(now + 0.05);
            }
            else if (type === 'error') {
                // –ì–ª—É—Ö–æ–π –∑–≤—É–∫ (–æ—à–∏–±–∫–∞/—É–¥–∞–ª–µ–Ω–∏–µ)
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            }
        }
    },


    // 3. –ë–õ–û–ö –¢–ê–ô–ú–ï–†–ê (–¢–ï–ü–ï–†–¨ –û–¢–î–ï–õ–¨–ù–û!)
    timer: {
        interval: null,
        targetTime: null, // –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
        mode: 'work',
        isRunning: false,
        currentTask: '',

        // 1. –û–¢–ö–†–´–¢–ò–ï
        open(taskName) {
            // –£–¥–∞–ª—è–µ–º –∫–∞–≤—ã—á–∫–∏, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞–ª—Å—è JS
            this.currentTask = taskName.replace(/['"]/g, "") || '–§–æ–∫—É—Å';
            this.setMode('work');
            document.getElementById('timer-task-name').innerText = this.currentTask;
            
            // –ü—Ä–æ—Å–∏–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            if (Notification.permission !== "granted") Notification.requestPermission();
            
            this.maximize(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–æ–ª—å—à–æ–µ –æ–∫–Ω–æ
        },

        // 2. –£–°–¢–ê–ù–û–í–ö–ê –†–ï–ñ–ò–ú–ê (–†–∞–±–æ—Ç–∞/–û—Ç–¥—ã—Ö)
        setMode(mode) {
            this.mode = mode;
            this.isRunning = false;
            clearInterval(this.interval);
            this.targetTime = null;

            const cont = document.getElementById('timer-container');
            const badge = document.getElementById('timer-mode-badge');
            const btn = document.getElementById('timer-btn');
            const btnRest = document.getElementById('btn-rest');
            
            const mins = mode === 'work' ? 40 : 15;
            
            if (mode === 'work') {
                cont.className = 'mode-work';
                badge.innerText = 'üí™ –í—Ä–µ–º—è —Ä–∞–±–æ—Ç–∞—Ç—å';
                btnRest.style.display = 'none';
            } else {
                cont.className = 'mode-rest';
                badge.innerText = '‚òï –í—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞';
                btnRest.style.display = 'none';
            }
            
            btn.innerText = '–°—Ç–∞—Ä—Ç';
            btn.style.background = mode==='work'?'var(--primary)':'var(--success)';
            this.renderTime(mins * 60);
        },

        toggle() { if(this.isRunning) this.pause(); else this.start(); },

        // 3. –ó–ê–ü–£–°–ö (–° –∑–∞—â–∏—Ç–æ–π –æ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —ç–∫—Ä–∞–Ω–∞)
        start() {
            if(!this.targetTime) {
                // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫: –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è + –º–∏–Ω—É—Ç—ã
                const mins = this.mode === 'work' ? 40 : 15;
                this.targetTime = Date.now() + (mins * 60 * 1000);
            } else {
                // –ï—Å–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏–ª–∏ –ø–æ—Å–ª–µ –ø–∞—É–∑—ã: –°—á–∏—Ç–∞–µ–º –Ω–æ–≤—ã–π —Ñ–∏–Ω–∏—à –æ—Ç —Ç–æ–≥–æ, —á—Ç–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
                const parts = document.getElementById('timer-val').innerText.split(':');
                const secLeft = parseInt(parts[0])*60 + parseInt(parts[1]);
                this.targetTime = Date.now() + (secLeft * 1000);
            }

            this.isRunning = true;
            document.getElementById('timer-btn').innerText = '–ü–∞—É–∑–∞';
            document.getElementById('timer-btn').style.background = 'var(--warning)';
            
            if(app.ui.renderBlob) app.ui.renderBlob(); // –í–∫–ª—é—á–∞–µ–º —â–∏—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å blob)

            this.interval = setInterval(() => {
                const diff = this.targetTime - Date.now();
                if (diff <= 0) {
                    this.finish();
                } else {
                    this.renderTime(Math.ceil(diff / 1000));
                }
            }, 1000);
        },

        pause() {
            this.isRunning = false;
            clearInterval(this.interval);
            this.targetTime = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ü–µ–ª—å (–ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ–º)
            document.getElementById('timer-btn').innerText = '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
            document.getElementById('timer-btn').style.background = this.mode==='work'?'var(--primary)':'var(--success)';
            if(app.ui.renderBlob) app.ui.renderBlob();
        },

        // 4. –°–í–û–†–ê–ß–ò–í–ê–ù–ò–ï / –†–ê–ó–í–û–†–ê–ß–ò–í–ê–ù–ò–ï
        minimize() {
            if(this.isRunning) {
                document.getElementById('modal-timer').style.display='none';
                document.getElementById('mini-timer').style.display='flex';
                document.getElementById('mini-timer-icon').innerText = this.mode==='work'?'üçÖ':'‚òï';
            } else {
                this.cancel(); // –ï—Å–ª–∏ –Ω–∞ –ø–∞—É–∑–µ - –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º
            }
        },

        maximize() {
            document.getElementById('mini-timer').style.display='none';
            document.getElementById('modal-timer').style.display='flex';
        },

        cancel() { 
            this.pause(); 
            document.getElementById('modal-timer').style.display='none'; 
            document.getElementById('mini-timer').style.display='none'; 
        },

        startRest() { this.setMode('rest'); this.start(); },

        // 5. –§–ò–ù–ò–®
        finish() {
            this.pause();
            this.renderTime(0);
            
            // –ó–≤—É–∫
            if(app.audio) app.audio.play('success');
            if(navigator.vibrate) navigator.vibrate([500, 200, 500]);
            
            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            if (Notification.permission === "granted") {
                new Notification(this.mode==='work' ? "üçÖ –í—Ä–µ–º—è –≤—ã—à–ª–æ!" : "üîã –û—Ç–¥—ã—Ö –æ–∫–æ–Ω—á–µ–Ω!", {
                    body: "–ù–∞–∂–º–∏ —Å—é–¥–∞, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å."
                });
            } else {
                alert("–í—Ä–µ–º—è –≤—ã—à–ª–æ!");
            }

            this.maximize(); // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É
            
            if(this.mode === 'work') {
                if(!app.state.tasks[app.viewDate]) app.state.tasks[app.viewDate] = [];
                app.state.tasks[app.viewDate].push({
                    id: Date.now(), text: `üçÖ –°–µ—Å—Å–∏—è: ${this.currentTask}`, cat: '–§–æ–∫—É—Å', points: 15, done: true
                });
                app.data.save();
                document.getElementById('btn-rest').style.display = 'block';
            }
        },

        renderTime(s) {
            const m = Math.floor(s/60).toString().padStart(2,'0');
            const sec = (s%60).toString().padStart(2,'0');
            const txt = `${m}:${sec}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ–∑–¥–µ
            document.getElementById('timer-val').innerText = txt;
            document.getElementById('mini-timer-val').innerText = txt;
            document.title = txt; // –í—Ä–µ–º—è –≤–æ –≤–∫–ª–∞–¥–∫–µ –±—Ä–∞—É–∑–µ—Ä–∞
        }
    },

    tasks: {
        nav(d) {
            const dt = new Date(app.viewDate); dt.setDate(dt.getDate() + d);
            app.viewDate = dt.toISOString().split('T')[0]; app.ui.updateAll();
            app.audio.play('click');
        },
        
        // –ü–†–û–í–ï–†–ö–ê –õ–ò–ú–ò–¢–ê –≠–ù–ï–†–ì–ò–ò –ü–†–ò –î–û–ë–ê–í–õ–ï–ù–ò–ò
        add() {
            const txt = document.getElementById('task-input').value; if(!txt) return;
            const cat = document.getElementById('task-cat').value;
            const rec = document.getElementById('task-recur').checked;
            const pts = {'–†–∞–±–æ—Ç–∞':10, '–¢–µ–ª–æ':5, '–§–æ–∫—É—Å':5, '–ë—ã—Ç':2}[cat];

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ä–µ–≥—É–ª—è—Ä–Ω–∞—è –∑–∞–¥–∞—á–∞
            if (!rec) {
                const date = app.viewDate;
                const mood = app.state.moods[date] || 3; // –ü–æ –¥–µ—Ñ–æ–ª—Ç—É 3
                // –õ–∏–º–∏—Ç—ã: 1=20–±–∞–ª–ª–æ–≤, 2=30... 5=–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ(1000)
                const limits = {1: 20, 2: 35, 3: 50, 4: 80, 5: 1000};
                
                // –°—á–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–∏–µ –±–∞–ª–ª—ã
                const currentPts = (app.state.tasks[date] || []).reduce((a,b)=>a+b.points,0);
                
                if (currentPts + pts > limits[mood]) {
                    if(!confirm(`‚ö†Ô∏è –û—Å—Ç–æ—Ä–æ–∂–Ω–æ!\n–¢–≤–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è –Ω–µ –æ—á–µ–Ω—å, –∞ —Ç—ã —É–∂–µ –Ω–∞–±—Ä–∞–ª –∑–∞–¥–∞—á –Ω–∞ ${currentPts} –±–∞–ª–ª–æ–≤.\n–õ–∏–º–∏—Ç –¥–ª—è —ç—Ç–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è: ${limits[mood]}.\n\n–¢–æ—á–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å?`)) {
                        return; // –û—Ç–º–µ–Ω—è–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
                    }
                }
            }

            if(rec) app.state.recurring.push({id: Date.now(), text: txt, cat, points: pts});
            else {
                if(!app.state.tasks[app.viewDate]) app.state.tasks[app.viewDate] = [];
                app.state.tasks[app.viewDate].push({id: Date.now(), text: txt, cat, points: pts, done: false, sub: [], expanded: false});
            }
            document.getElementById('task-input').value = '';
            document.getElementById('task-recur').checked = false;
            app.audio.play('click');
            app.data.save();
        },
        
        // –ö–û–ù–§–ï–¢–¢–ò –ò –ó–í–£–ö –ü–†–ò –ó–ê–í–ï–†–®–ï–ù–ò–ò
        toggle(id) {
            let t = (app.state.tasks[app.viewDate]||[]).find(x => x.id === id);
            let justDone = false;
            
            if(t) { 
                t.done = !t.done; 
                if(t.done) justDone = true;
            } else {
                const tmpl = app.state.recurring.find(x => x.id === id);
                if(tmpl) {
                    if(!app.state.tasks[app.viewDate]) app.state.tasks[app.viewDate] = [];
                    app.state.tasks[app.viewDate].push({id: tmpl.id, realId: Date.now(), text: tmpl.text, cat: tmpl.cat, points: tmpl.points, done: true, sub: [], expanded: false, isRecurInstance: true});
                    justDone = true;
                }
            }
            
            if(justDone) {
                app.audio.play('success');
                app.ui.triggerConfetti();
            } else {
                app.audio.play('click');
            }
            app.data.save();
        },
        
        addSub(id) {
            const t = this.find(id); const txt = prompt('–ü–æ–¥–∑–∞–¥–∞—á–∞:');
            if(t && txt) { t.sub.push({text: txt, done: false}); t.expanded = true; app.data.save(); }
        },
        togSub(tid, idx) {
            const t = this.find(tid);
            if(t) { 
                t.sub[idx].done = !t.sub[idx].done; 
                if(t.sub.every(s=>s.done)) t.done=true; else t.done=false; 
                app.data.save(); 
            }
        },
        togList(id) { const t = this.find(id); if(t) { t.expanded = !t.expanded; app.data.save(); } },
        del(id) {
            if(confirm('–£–¥–∞–ª–∏—Ç—å?')) {
                const rIdx = app.state.recurring.findIndex(t => t.id === id);
                if(rIdx !== -1) app.state.recurring.splice(rIdx, 1);
                if(app.state.tasks[app.viewDate]) app.state.tasks[app.viewDate] = app.state.tasks[app.viewDate].filter(t => (t.realId || t.id) !== id);
                app.audio.play('error');
                app.data.save();
            }
        },
        find(id) { return (app.state.tasks[app.viewDate]||[]).find(x => x.id === id || x.realId === id); },
        getListForView() {
            const reg = app.state.tasks[app.viewDate] || [];
            const gh = app.state.recurring.filter(tpl => !reg.some(t => t.id === tpl.id)).map(tpl => ({...tpl, done: false, isGhost: true, expanded: false, sub: []}));
            return [...reg, ...gh];
        }
    },

    goals: {
        add() {
            const t = document.getElementById('goal-title').value;
            const type = document.getElementById('goal-type').value;
            const tg = parseFloat(document.getElementById('goal-target').value) || 0;
            if(!t) return;
            app.state.goals.push({ id: Date.now(), title: t, type, target: tg, sub: [], done: false, expanded: true });
            document.getElementById('modal-add-goal').style.display='none';
            app.data.save();
        },
        addSub(gid) {
            const g = app.state.goals.find(x => x.id === gid);
            const txt = prompt('–≠—Ç–∞–ø:');
            if(g && txt) { g.sub.push({text: txt, done: false}); g.expanded = true; app.data.save(); }
        },
        togSub(gid, idx) {
            const g = app.state.goals.find(x => x.id === gid);
            g.sub[idx].done = !g.sub[idx].done;
            app.data.save();
        },
        togList(gid) {
            const g = app.state.goals.find(x => x.id === gid);
            if(g) { if(g.expanded === undefined) g.expanded = true; g.expanded = !g.expanded; app.data.save(); }
        },
        del(gid) { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { app.state.goals = app.state.goals.filter(x => x.id !== gid); app.data.save(); } }
    },

    achievements: {
        list: [],
        gen() {
             const c = (id, icon, title, desc, check) => this.list.push({id, icon, title, desc, check});
             c('t1', 'üöÄ', '–ü–µ—Ä–≤—ã–π —à–∞–≥', '–í—ã–ø–æ–ª–Ω–∏ 1 –∑–∞–¥–∞—á—É', s => s.doneT >= 1);
             c('t10', 'üéØ', '–†–∞–∑–≥–æ–Ω', '–í—ã–ø–æ–ª–Ω–∏ 10 –∑–∞–¥–∞—á —Å—É–º–º–∞—Ä–Ω–æ', s => s.doneT >= 10);
             c('t50', 'üî•', '–ú–∞—à–∏–Ω–∞', '–ó–∞–∫—Ä–æ–π 50 –∑–∞–¥–∞—á. –¢—ã –º–æ–Ω—Å—Ç—Ä –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏!', s => s.doneT >= 50);
             c('m1', 'ü§ë', '–ü–µ—Ä–≤—ã–π –¥–æ—Ö–æ–¥', '–ó–∞–ø–∏—à–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –¥–æ—Ö–æ–¥', s => s.incOps >= 1);
             c('s3', 'üëü', '–°—Ç—Ä–∏–∫ 3 –¥–Ω—è', '–ù–µ –ø—Ä–æ–ø—É—Å–∫–∞–π –∑–∞–¥–∞—á–∏ 3 –¥–Ω—è –ø–æ–¥—Ä—è–¥', s => s.streak >= 3);
             c('s7', 'üèÉ', '–°—Ç—Ä–∏–∫ –ù–µ–¥–µ–ª—è', '–î–µ—Ä–∂–∏ —Ç–µ–º–ø —Ü–µ–ª—É—é –Ω–µ–¥–µ–ª—é –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤', s => s.streak >= 7);
        },
        check() {
            const allT = Object.values(app.state.tasks).flat();
            const doneT = allT.filter(x => x.done).length;
            const incOps = app.state.finances.filter(x => x.type === 'income').length;
            let streak = 0; const d = new Date();
            while(true) {
                const dt = d.toISOString().split('T')[0];
                const pt = (app.state.tasks[dt]||[]).filter(t=>t.done).reduce((a,b)=>a+b.points,0);
                if(pt>0) streak++; else if(dt !== new Date().toISOString().split('T')[0]) break;
                d.setDate(d.getDate()-1); if(streak > 365) break;
            }
            const st = {doneT, incOps, streak};
            let ch = false;
            this.list.forEach(a => {
                if(!app.state.achievements[a.id] && a.check(st)) {
                    app.state.achievements[a.id] = true; alert(`üèÜ –î–û–°–¢–ò–ñ–ï–ù–ò–ï:\n${a.title}\n${a.desc}`); ch = true;
                }
            });
            if(ch) app.data.save();
            return streak;
        }
    },

    ui: {
        calcTotalPoints() {
            let sum = 0;
            if(app.state.tasks) Object.values(app.state.tasks).flat().forEach(t => { if(t.done) sum += t.points; });
            return sum;
        },
        
        // --- –õ–û–ì–ò–ö–ê "–ñ–ò–í–û–ì–û –°–ï–†–î–¶–ê" ---
        // --- –£–ú–ù–û–ï –ñ–ò–í–û–ï –°–ï–†–î–¶–ï ---
        renderBlob() {
            const blob = document.getElementById('blob');
            if(!blob) return;
            
            const date = new Date().toISOString().split('T')[0];
            
            // 1. –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
            const mood = app.state.moods[date] || 3; // 1..5
            const tasks = app.state.tasks[date] || [];
            const points = tasks.filter(t=>t.done).reduce((a,b)=>a+b.points,0);
            
            const fins = app.state.finances.filter(f => f.date === date);
            const income = fins.filter(f=>f.type==='income').reduce((a,b)=>a+b.amount,0);
            const expense = fins.filter(f=>f.type==='expense').reduce((a,b)=>a+b.amount,0);

            // –ë–∞–∑–æ–≤—ã–π —Ü–≤–µ—Ç –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
            const colors = {1:'#ff7675', 2:'#fdcb6e', 3:'#b2bec3', 4:'#74b9ff', 5:'#6c5ce7'};
            blob.style.background = colors[mood];
            blob.className = 'living-blob'; // –°–±—Ä–æ—Å –∫–ª–∞—Å—Å–æ–≤
            
            // --- –õ–û–ì–ò–ö–ê –°–û–°–¢–û–Ø–ù–ò–ô (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã) ---

            // 1. –§–û–ö–£–° (–í—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ —Ç–∞–π–º–µ—Ä –≤ —Ä–µ–∂–∏–º–µ "–†–∞–±–æ—Ç–∞"
            if (app.timer && app.timer.isRunning && app.timer.mode === 'work') {
                blob.classList.add('blob-shield');
                blob.title = "–†–µ–∂–∏–º –§–æ–∫—É—Å–∞: –ê–∫—Ç–∏–≤–µ–Ω";
                return; 
            }

            // 2. –§–ò–ù–ê–ù–°–û–í–ê–Ø –ü–ê–ù–ò–ö–ê (–ï—Å–ª–∏ –ø–æ—Ç—Ä–∞—Ç–∏–ª –±–æ–ª—å—à–µ, —á–µ–º –∑–∞—Ä–∞–±–æ—Ç–∞–ª —Å–µ–≥–æ–¥–Ω—è, –∏ —Ä–∞—Å—Ö–æ–¥—ã > 0)
            // (–ò–ª–∏ –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –∂–µ—Å—Ç–∫–∏–π –ª–∏–º–∏—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä > 1000)
            if (expense > income && expense > 0) {
                blob.classList.add('blob-panic');
                blob.title = "–¢—Ä–µ–≤–æ–≥–∞: –†–∞—Å—Ö–æ–¥—ã –ø—Ä–µ–≤—ã—à–∞—é—Ç –¥–æ—Ö–æ–¥—ã!";
                return;
            }

            // 3. –î–ï–ü–†–ï–°–°–ò–Ø (–ü–ª–æ—Ö–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ)
            if (mood <= 2) {
                blob.classList.add('blob-sad');
                blob.title = "–ù–∏–∑–∫–∏–π –∑–∞—Ä—è–¥ —ç–Ω–µ—Ä–≥–∏–∏";
                return;
            }

            // 4. –ü–†–û–î–£–ö–¢–ò–í–ù–û–°–¢–¨ (–û–±—ã—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
            if (points > 30) {
                blob.classList.add('blob-power'); // –ú–æ—â–Ω—ã–π
                blob.title = "–¢—ã –≤ –ø–æ—Ç–æ–∫–µ!";
            } else {
                // –û–±—ã—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ø—Ä–æ—Å—Ç–æ –∂–∏–≤–µ—Ç)
                blob.title = "–ü—É–ª—å—Å –≤ –Ω–æ—Ä–º–µ";
            }
        },

        // --- –ö–û–ù–§–ï–¢–¢–ò ---
        triggerConfetti() {
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∞–ª—é—Ç –∏–∑ –¥–≤—É—Ö –Ω–∏–∂–Ω–∏—Ö —É–≥–ª–æ–≤
            confetti({ particleCount: 60, spread: 55, origin: { x: 0, y: 1 }, colors: ['#6c5ce7', '#00b894'] });
            confetti({ particleCount: 60, spread: 55, origin: { x: 1, y: 1 }, colors: ['#6c5ce7', '#fdcb6e'] });
        },

        setFilter(mode, el) {
            const p = document.getElementById('custom-date-panel');
            if(mode === 'custom') { p.classList.remove('hidden'); p.style.display='flex'; } 
            else { p.classList.add('hidden'); p.style.display='none'; }
            if(el) { document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active')); el.classList.add('active'); }
            app.filter.calc(mode); this.updateAll();
        },
        toggleCustomDate() {
            const p = document.getElementById('custom-date-panel');
            if (p.classList.contains('hidden')) { p.classList.remove('hidden'); p.style.display='flex'; } else { p.classList.add('hidden'); p.style.display='none'; }
        },
        updateAll() {
            this.renderStats(); 
            this.renderTasks(); 
            this.renderWallet(); 
            this.renderGoals(); 
            this.renderAch();
            this.renderBlob(); // –û–±–Ω–æ–≤–ª—è–µ–º –±–ª–æ–±
            if(app.shop) app.shop.render();
            if(app.mood) app.mood.render();
        },
        
        // ... (–û—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã renderStats, renderTasks –∏ –¥—Ä. –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, 
        // –Ω–æ –ª—É—á—à–µ —Å–∫–æ–ø–∏—Ä—É–π –∏—Ö –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –ø–æ–º–µ—Å—Ç–∏–ª–∏—Å—å)
        
        renderStats() {
            const fins = app.finance.getFiltered();
            const targetCurr = app.state.settings.currency;
            let inc = 0, exp = 0;
            const expByCat = {}; 
            fins.forEach(f => {
                const v = (f.amount / app.rates[f.curr]) * app.rates[targetCurr];
                if(f.type === 'income') { inc += v; } else { exp += v; expByCat[f.cat] = (expByCat[f.cat] || 0) + v; }
            });
            const sym = app.syms[targetCurr];
            const balance = inc - exp;
            
            document.getElementById('balance-display').innerText = balance.toFixed(0) + ' ' + sym;
            document.getElementById('balance-display').style.color = balance >= 0 ? 'var(--text-main)' : 'var(--danger)';
            document.getElementById('stat-inc').innerText = inc.toFixed(0) + ' ' + sym;
            document.getElementById('stat-exp').innerText = exp.toFixed(0) + ' ' + sym;
            document.querySelectorAll('.curr').forEach(e => e.innerText = sym);
            
            document.getElementById('streak-val').innerText = app.achievements.check();
            document.getElementById('total-points-display').innerText = app.ui.calcTotalPoints();

            // Charts
            const days = []; for(let k=6; k>=0; k--) { const d=new Date(); d.setDate(d.getDate()-k); days.push(d.toISOString().split('T')[0]); }
            const ce = document.getElementById('chart-energy'); ce.innerHTML = '';
            const cf = document.getElementById('chart-finance'); cf.innerHTML = '';
            
            let maxFin = 100;
            days.forEach(d => {
                 const df = app.state.finances.filter(f=>f.date===d);
                 let di=0, de=0;
                 df.forEach(f=>{ const v=(f.amount/app.rates[f.curr])*app.rates[targetCurr]; if(f.type==='income') di+=v; else de+=v; });
                 if(di>maxFin) maxFin=di; if(de>maxFin) maxFin=de;
            });
            
            let maxPts = 10;
            const ppd = days.map(d => (app.state.tasks[d]||[]).filter(t=>t.done).reduce((a,b)=>a+b.points,0));
            maxPts = Math.max(10, ...ppd);

            days.forEach((d, i) => {
                const pt = ppd[i];
                ce.innerHTML += `<div class="bar-col"><div class="bar" style="height:${(pt/maxPts)*100}%; background:var(--primary)"></div></div>`;
                const df = app.state.finances.filter(f=>f.date===d);
                let di=0, de=0;
                df.forEach(f=>{ const v=(f.amount/app.rates[f.curr])*app.rates[targetCurr]; if(f.type==='income') di+=v; else de+=v; });
                cf.innerHTML += `<div class="bar-col"><div style="display:flex; align-items:flex-end; gap:2px; height:100%; width:100%; justify-content:center"><div class="bar" style="width:12px; background:var(--success); height:${(di/maxFin)*100}%"></div><div class="bar" style="width:12px; background:var(--danger); height:${(de/maxFin)*100}%"></div></div></div>`;
            });

            // Pie Chart
            const pieContainer = document.getElementById('expense-pie-chart-wrapper');
            if (exp === 0) { pieContainer.innerHTML = '–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤'; } else {
                const sortedCats = Object.entries(expByCat).sort((a, b) => b[1] - a[1]);
                const colors = ['#ff7675', '#74b9ff', '#55efc4', '#a29bfe', '#fdcb6e', '#e17055', '#00b894', '#636e72'];
                let gradientStr = ''; let startPerc = 0; let legendHtml = '';
                sortedCats.forEach((item, index) => {
                    const [catName, amount] = item;
                    const perc = (amount / exp) * 100;
                    const endPerc = startPerc + perc;
                    const color = colors[index % colors.length];
                    gradientStr += `${color} ${startPerc}% ${endPerc}%, `;
                    startPerc = endPerc;
                    legendHtml += `<div class="legend-item"><div class="legend-color" style="background:${color}"></div><span>${catName}: <b>${amount.toFixed(0)}</b> (${perc.toFixed(0)}%)</span></div>`;
                });
                gradientStr = gradientStr.slice(0, -2);
                pieContainer.innerHTML = `<div class="pie-chart-container"><div class="pie-chart" style="background: conic-gradient(${gradientStr})"></div><div class="chart-legend">${legendHtml}</div></div>`;
            }
        },
        
        renderTasks() {
            document.getElementById('task-date-label').innerText = app.viewDate;
            const c = document.getElementById('tasks-container'); c.innerHTML = '';
            const lst = app.tasks.getListForView();
            if(lst.length===0) c.innerHTML = '<div style="text-align:center; opacity:0.5; padding:20px">–ù–µ—Ç –∑–∞–¥–∞—á</div>';
            
            lst.forEach(t => {
                const gh = t.isGhost;
                const id = gh ? t.id : (t.realId || t.id);
                const arrow = t.expanded ? '‚ñº' : '‚ñ∂';
                const dSub = t.expanded ? 'block' : 'none';
                let sH = '';
                if(t.sub) t.sub.forEach((s,i) => {
                    sH += `<div class="subtask"><input type="checkbox" ${s.done?'checked':''} onchange="app.tasks.togSub(${id},${i})"><span style="margin-left:8px; text-decoration:${s.done?'line-through':''}">${s.text}</span></div>`;
                });
                const delBtn = `<button class="btn-toggle" style="color:var(--danger); font-size:1.4rem; padding:0 5px; line-height:1;" onclick="app.tasks.del(${id})">√ó</button>`;
                
                let timerBtn = '';
                if (t.cat === '–†–∞–±–æ—Ç–∞' || t.cat === '–§–æ–∫—É—Å') {
                    const safeText = t.text.replace(/'/g, "");
                    timerBtn = `<button class="btn-focus" onclick="app.timer.open('${safeText}')">‚è± –§–æ–∫—É—Å</button>`;
                }

                c.innerHTML += `
                    <div class="task-item" style="border-left-color:${t.done?'var(--success)':'var(--primary)'}; opacity:${t.done?0.7:1}">
                        <div style="display:flex; justify-content:space-between; align-items:center">
                            <div style="display:flex; align-items:center; flex:1">
                                <input type="checkbox" ${t.done?'checked':''} onchange="app.tasks.toggle(${t.id})" style="width:20px;height:20px;margin:0">
                                <div style="margin-left:10px">
                                    <span style="font-weight:600; text-decoration:${t.done?'line-through':''}">${t.text}</span>
                                    ${gh ? '<span class="recurring-badge">‚Üª</span>' : ''}
                                </div>
                            </div>
                            <div style="display:flex; gap:5px; align-items:center">
                                <small style="opacity:0.6; margin-right:5px">${t.points}–±</small>
                                ${timerBtn}
                                ${delBtn}
                                <button class="btn-toggle" onclick="app.tasks.togList(${id})">${arrow}</button>
                            </div>
                        </div>
                        <div class="subtasks-list" style="display:${dSub}">
                            ${sH}
                            ${!gh ? `<div style="font-size:0.8rem; color:var(--primary); cursor:pointer; margin-top:5px" onclick="app.tasks.addSub(${id})">+ –ü–æ–¥–∑–∞–¥–∞—á–∞</div>` : ''}
                        </div>
                    </div>`;
            });
        },
        
        renderWallet() {
            const cont = document.getElementById('wallet-history'); 
            cont.innerHTML = '';
            let list = app.finance.getFiltered();
            const typeFilter = document.getElementById('wallet-filter-type')?.value || 'all';
            if (typeFilter !== 'all') list = list.filter(f => f.type === typeFilter);
            const catFilter = document.getElementById('wallet-filter-cat')?.value || 'all';
            if (catFilter !== 'all') list = list.filter(f => f.cat === catFilter);
            
            const sortMode = document.getElementById('wallet-sort')?.value || 'date-desc';
            list.sort((a, b) => {
                if (sortMode === 'date-desc') return new Date(b.date) - new Date(a.date) || b.id - a.id;
                if (sortMode === 'date-asc') return new Date(a.date) - new Date(b.date) || a.id - b.id;
                const valA = (a.amount / app.rates[a.curr]);
                const valB = (b.amount / app.rates[b.curr]);
                if (sortMode === 'amount-desc') return valB - valA;
                if (sortMode === 'amount-asc') return valA - valB;
                return 0;
            });

            if(list.length === 0) {
                cont.innerHTML='<div style="text-align:center; opacity:0.5; padding:20px">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div>';
                return;
            }

            list.forEach(f => {
                const val = (f.amount / app.rates[f.curr]) * app.rates[app.state.settings.currency];
                const sym = app.syms[app.state.settings.currency];
                const col = f.type==='income'?'var(--success)':'var(--danger)';
                const sign = f.type==='income'?'+':'-';
                cont.innerHTML += `
                    <div class="history-item">
                        <div><b>${f.cat}</b> <br> <small style="color:#aaa">${f.date}</small></div>
                        <div style="text-align:right">
                            <div style="color:${col}; font-weight:bold">${sign} ${val.toFixed(0)} ${sym}</div>
                            <small style="opacity:0.5; font-size:0.7rem">${f.amount} ${app.syms[f.curr]}</small>
                        </div>
                    </div>`;
            });
        },
        
        renderGoals() {
            const c = document.getElementById('goals-list'); c.innerHTML = '';
            app.state.goals.forEach(g => {
                const open = g.expanded !== false;
                const arrow = open ? '‚ñº' : '‚ñ∂';
                const dBody = open ? 'block' : 'none';
                let cnt = '';
                if(g.type === 'custom') {
                    const dn = g.sub.filter(s=>s.done).length, tot = g.sub.length;
                    const p = tot ? (dn/tot)*100 : 0;
                    let sh = ''; g.sub.forEach((s,i) => sh += `<div class="subtask"><input type="checkbox" ${s.done?'checked':''} onchange="app.goals.togSub(${g.id},${i})"><span style="margin-left:5px">${s.text}</span></div>`);
                    cnt = `<div class="progress-bar"><div class="progress-fill" style="width:${p}%"></div></div><div style="display:${dBody}">${sh}<button class="btn btn-sm" style="margin-top:5px; width:100%" onclick="app.goals.addSub(${g.id})">+ –≠—Ç–∞–ø</button></div>`;
                } else {
                    const f = app.finance.getFiltered().filter(x=>x.type==='income');
                    const ti = f.reduce((a,b)=>a+((b.amount/app.rates[b.curr])*app.rates[app.state.settings.currency]),0);
                    const p = g.target>0 ? Math.min(100,(ti/g.target)*100) : 0;
                    cnt = `<div style="font-size:0.8rem; display:${dBody}">–°–æ–±—Ä–∞–Ω–æ: <b>${ti.toFixed(0)}</b> / ${g.target}</div><div class="progress-bar"><div class="progress-fill" style="width:${p}%"></div></div>`;
                }
                c.innerHTML += `<div class="goal-item"><div class="goal-header"><div style="display:flex; gap:10px; align-items:center" onclick="app.goals.togList(${g.id})"><span class="btn-toggle" style="font-size:1rem">${arrow}</span> <b>${g.title}</b></div><button class="btn-toggle" style="color:var(--danger)" onclick="app.goals.del(${g.id})">‚úï</button></div>${cnt}</div>`;
            });
        },
        
        renderAch() {
            const c = document.getElementById('ach-container'); c.innerHTML = '';
            app.achievements.list.forEach(a => {
                const u = app.state.achievements[a.id];
                c.innerHTML += `
                <div onclick="alert('${a.title}\\n\\n${a.desc}')" title="${a.desc}" style="
                    background: ${u ? 'var(--card-bg)' : 'rgba(0,0,0,0.05)'};
                    border: 1px solid ${u ? 'var(--primary)' : 'transparent'};
                    opacity: ${u ? 1 : 0.5};
                    filter: ${u ? 'none' : 'grayscale(1)'};
                    padding: 10px; border-radius: 15px; text-align: center;
                    display: flex; flex-direction: column; align-items: center; justify-content: center;
                    box-shadow: ${u ? 'var(--shadow)' : 'none'};
                    cursor: pointer; transition: 0.2s;
                ">
                    <div style="font-size: 2rem; margin-bottom: 5px;">${a.icon}</div>
                    <div style="font-size: 0.65rem; font-weight: bold; line-height: 1.2;">${a.title}</div>
                </div>`;
            });
        },
        
        tab(id, btn) {
            document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            btn.classList.add('active');
            this.updateAll();
        },
        modal(id) { document.getElementById('modal-'+id).style.display='flex'; if(id==='achievements') this.renderAch(); },
        theme() { 
            app.state.settings.theme = app.state.settings.theme==='light'?'dark':'light'; 
            document.body.setAttribute('data-theme', app.state.settings.theme);
            app.data.save();
        }
    }, // –ó–∞–∫—Ä—ã–≤–∞–µ–º ui

    // –í–û–¢ –≠–¢–û–ì–û –ë–õ–û–ö–ê –ù–ï –•–í–ê–¢–ê–õ–û:
    settings: {
        save() { app.state.settings.currency = document.getElementById('sets-curr').value; app.data.save(); }
    }

}; // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤–µ—Å—å –æ–±—ä–µ–∫—Ç app (–≠–¢–û–ô –°–ö–û–ë–ö–ò –ù–ï –ë–´–õ–û)

// –ó–∞–ø—É—Å–∫
window.onload = () => app.init();
</script>
</body>
</html>
