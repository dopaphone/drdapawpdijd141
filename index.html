<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¢–ï–ü–õ–û</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ–º—ã */
            --bg-color: #f0f3f8;
            --card-bg: rgba(255, 255, 255, 0.9);
            --text-main: #2d3436;
            --text-sec: #636e72;
            
            --primary: #6c5ce7; 
            --primary-dark: #5849be;
            --accent: #00cec9;
            --success: #00b894;
            --danger: #ff7675;
            
            --shadow-out: 6px 6px 12px rgba(163, 177, 198, 0.6), -6px -6px 12px rgba(255, 255, 255, 1);
            --shadow-in: inset 4px 4px 8px rgba(163, 177, 198, 0.4), inset -4px -4px 8px rgba(255, 255, 255, 1);
            --shadow-hover: 8px 8px 16px rgba(163, 177, 198, 0.7), -8px -8px 16px rgba(255, 255, 255, 1);
            
            --radius: 20px;
            --font-main: 'Montserrat', sans-serif;
        }

        [data-theme="dark"] {
            --bg-color: #212529;
            --card-bg: rgba(44, 48, 52, 0.95);
            --text-main: #f1f3f5;
            --text-sec: #adb5bd;
            --primary: #a29bfe; 
            --primary-dark: #847cdf;
            --shadow-out: 5px 5px 10px rgba(0,0,0,0.5), -4px -4px 10px rgba(255,255,255,0.05);
            --shadow-in: inset 4px 4px 8px rgba(0,0,0,0.5), inset -3px -3px 8px rgba(255,255,255,0.05);
            --shadow-hover: 7px 7px 14px rgba(0,0,0,0.6), -4px -4px 10px rgba(255,255,255,0.08);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0; padding: 0 0 110px 0;
            background: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-main);
            transition: background 0.3s ease;
            overflow-x: hidden;
        }

        /* --- UI COMPONENTS --- */
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-out);
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.2s;
        }

        h1, h2, h3 { margin: 0; font-weight: 800; letter-spacing: -0.5px; }
        h2 { font-size: 1.3rem; margin-bottom: 15px; background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* --- BUTTONS --- */
        button { border: none; cursor: pointer; font-family: inherit; font-weight: 700; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .btn {
            padding: 14px 20px; border-radius: 16px;
            background: var(--bg-color); color: var(--text-main);
            box-shadow: var(--shadow-out);
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            font-size: 0.9rem;
        }
        
        .btn:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); }
        .btn:active { transform: scale(0.95); box-shadow: var(--shadow-in); }
        
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-circle { width: 44px; height: 44px; padding: 0; border-radius: 50%; font-size: 1.2rem; }

        /* --- INPUTS --- */
        input, select {
            width: 100%; padding: 15px; border-radius: 16px; border: none;
            background: var(--bg-color); color: var(--text-main);
            box-shadow: var(--shadow-in); margin-bottom: 15px;
            font-size: 1rem; font-family: inherit; appearance: none;
        }

        /* --- HEADER --- */
        header {
            position: sticky; top: 0; z-index: 100;
            padding: 15px 20px;
            background: rgba(255,255,255,0.01); backdrop-filter: blur(12px);
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo { font-size: 1.8rem; font-weight: 900; color: var(--text-main); letter-spacing: 1px; }

        /* --- TABS --- */
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }

        /* --- TASK LIST --- */
        .task-card {
            background: var(--bg-color); border-radius: 16px; padding: 16px;
            margin-bottom: 12px; box-shadow: var(--shadow-out);
            border-left: 6px solid transparent; transition: 0.3s;
        }
        .task-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .task-title { font-weight: 600; font-size: 1.05rem; flex: 1; margin-left: 12px; }
        .task-done-text { text-decoration: line-through; opacity: 0.6; }
        
        .subtasks-container {
            margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.05);
            display: none; animation: slideDown 0.3s ease;
        }
        .subtask-item { display: flex; align-items: center; margin-top: 10px; font-size: 0.9rem; background: rgba(0,0,0,0.02); padding: 8px; border-radius: 10px; }
        
        /* --- CHART BARS --- */
        .chart-container { height: 180px; display: flex; align-items: flex-end; justify-content: space-between; gap: 4px; padding-top: 20px; }
        .bar-col { flex: 1; display: flex; flex-direction: column; justify-content: flex-end; height: 100%; align-items: center; }
        .bar { width: 80%; border-radius: 8px 8px 0 0; min-height: 4px; transition: height 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .bar-label { font-size: 0.65rem; margin-top: 6px; color: var(--text-sec); text-align: center; }

        /* --- STREAK BADGE --- */
        .streak-card {
            background: linear-gradient(135deg, #FF9966, #FF5E62);
            color: white; text-align: center; padding: 15px; border-radius: 20px;
            margin-bottom: 20px; box-shadow: 0 10px 20px rgba(255, 94, 98, 0.3);
        }

        /* --- NAV BAR --- */
        .nav-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 450px;
            background: var(--card-bg); backdrop-filter: blur(20px);
            border-radius: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: flex; justify-content: space-around; padding: 10px; z-index: 999;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-sec); opacity: 0.6; transition: 0.3s;
            width: 55px; height: 55px; border-radius: 20px;
        }
        .nav-item.active { opacity: 1; color: var(--primary); background: rgba(108, 92, 231, 0.1); transform: translateY(-5px); }
        .nav-icon { font-size: 1.5rem; margin-bottom: 2px; }

        /* --- MODALS --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: var(--bg-color); width: 90%; max-width: 400px; padding: 30px; border-radius: 30px; box-shadow: var(--shadow-out); }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .date-filters { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 15px; scrollbar-width: none; }
    </style>
</head>
<body data-theme="light">

<header>
    <div class="logo">–¢–ï–ü–õ–û</div>
    <div style="display: flex; gap: 10px;">
        <button class="btn btn-circle" onclick="app.ui.toggleModal('settings-modal')">‚öôÔ∏è</button>
    </div>
</header>

<div id="tab-stats" class="container tab-content active">
    
    <div class="streak-card">
        <div style="font-size: 3rem; font-weight: 900;" id="streak-count">0</div>
        <div style="font-size: 0.9rem; opacity: 0.9;">–¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ —Ç—ã –≤ –ø–æ—Ç–æ–∫–µ üî•</div>
    </div>

    <div class="card">
        <div class="date-filters">
            <button class="btn active" onclick="app.stats.setPeriod('today', this)" style="padding: 10px 15px;">–°–µ–≥–æ–¥–Ω—è</button>
            <button class="btn" onclick="app.stats.setPeriod('week', this)" style="padding: 10px 15px;">–ù–µ–¥–µ–ª—è</button>
            <button class="btn" onclick="app.stats.setPeriod('month', this)" style="padding: 10px 15px;">–ú–µ—Å—è—Ü</button>
        </div>
        <h3 id="stats-period-label" style="text-align: center; color: var(--text-sec); font-size: 0.9rem;">–°–µ–≥–æ–¥–Ω—è</h3>
    </div>

    <div class="card">
        <h2>‚ö° –≠–Ω–µ—Ä–≥–∏—è</h2>
        <div class="chart-container" id="energy-chart"></div>
        <div style="text-align: center; margin-top: 15px; font-weight: 600;">–í—Å–µ–≥–æ –±–∞–ª–ª–æ–≤: <span id="total-points" style="color: var(--primary);">0</span></div>
    </div>

    <div class="card">
        <h2>üìä –§–∏–Ω–∞–Ω—Å—ã (<span class="currency-symbol">$</span>)</h2>
        <div class="chart-container" id="finance-chart"></div>
        <div style="display: flex; justify-content: space-around; margin-top: 15px; font-weight: 600;">
            <span style="color: var(--success)">+ <span id="total-inc">0</span></span>
            <span style="color: var(--danger)">- <span id="total-exp">0</span></span>
        </div>
    </div>
</div>

<div id="tab-tasks" class="container tab-content">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button class="btn btn-circle" onclick="app.tasks.changeDay(-1)">‚óÄ</button>
            <h3 id="current-date-display">–°–µ–≥–æ–¥–Ω—è</h3>
            <button class="btn btn-circle" onclick="app.tasks.changeDay(1)">‚ñ∂</button>
        </div>

        <input type="text" id="new-task-text" placeholder="–Ø —Ö–æ—á—É —Å–¥–µ–ª–∞—Ç—å..." onkeypress="if(event.key==='Enter') app.tasks.add()">
        <div style="display: flex; gap: 10px;">
            <select id="new-task-cat">
                <option value="–†–∞–±–æ—Ç–∞">üíº –†–∞–±–æ—Ç–∞</option>
                <option value="–¢–µ–ª–æ">üí™ –¢–µ–ª–æ</option>
                <option value="–§–æ–∫—É—Å">üß† –§–æ–∫—É—Å</option>
                <option value="–ë—ã—Ç">üè† –ë—ã—Ç</option>
            </select>
            <button class="btn btn-primary" onclick="app.tasks.add()">+</button>
        </div>
    </div>

    <div id="tasks-list"></div>
</div>

<div id="tab-income" class="container tab-content">
    <div class="card">
        <h2>üí∞ –î–æ—Ö–æ–¥</h2>
        <input type="number" id="inc-amount" placeholder="–°—É–º–º–∞" inputmode="decimal">
        <select id="inc-cat">
            <option value="–ó–∞—Ä–ø–ª–∞—Ç–∞">–ó–∞—Ä–ø–ª–∞—Ç–∞</option>
            <option value="–§—Ä–∏–ª–∞–Ω—Å">–§—Ä–∏–ª–∞–Ω—Å</option>
            <option value="–ü–µ—Ä–µ–≤–æ–¥">–ü–µ—Ä–µ–≤–æ–¥</option>
            <option value="–ü–æ–¥–∞—Ä–æ–∫">–ü–æ–¥–∞—Ä–æ–∫</option>
            <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
        </select>
        <button class="btn btn-primary" style="width: 100%; background: var(--success);" onclick="app.finance.add('income')">–ó–∞—á–∏—Å–ª–∏—Ç—å</button>
    </div>
    <div id="income-history"></div>
</div>

<div id="tab-expense" class="container tab-content">
    <div class="card">
        <h2>üí∏ –†–∞—Å—Ö–æ–¥</h2>
        <input type="number" id="exp-amount" placeholder="–°—É–º–º–∞" inputmode="decimal">
        <select id="exp-cat">
            <option value="–ï–¥–∞">–ï–¥–∞</option>
            <option value="–°–∏–≥–∞—Ä–µ—Ç—ã">üö¨ –°–∏–≥–∞—Ä–µ—Ç—ã</option>
            <option value="–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è">üéâ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
            <option value="–ö–≤–∞—Ä—Ç–∏—Ä–∞">üè† –ö–≤–∞—Ä—Ç–∏—Ä–∞</option>
            <option value="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç">üöï –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>
            <option value="–ó–¥–æ—Ä–æ–≤—å–µ">üíä –ó–¥–æ—Ä–æ–≤—å–µ</option>
            <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
        </select>
        <button class="btn btn-primary" style="width: 100%; background: var(--danger);" onclick="app.finance.add('expense')">–°–ø–∏—Å–∞—Ç—å</button>
    </div>
    <div id="expense-history"></div>
</div>

<nav class="nav-bar">
    <div class="nav-item active" onclick="app.ui.switchTab('stats', this)">
        <div class="nav-icon">üìä</div>
    </div>
    <div class="nav-item" onclick="app.ui.switchTab('tasks', this)">
        <div class="nav-icon">üéØ</div>
    </div>
    <div class="nav-item" onclick="app.ui.switchTab('income', this)">
        <div class="nav-icon">üí∞</div>
    </div>
    <div class="nav-item" onclick="app.ui.switchTab('expense', this)">
        <div class="nav-icon">üí∏</div>
    </div>
</nav>

<div id="settings-modal" class="modal" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal-content">
        <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <br>
        <label style="font-weight: bold; margin-bottom: 5px; display: block;">–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è:</label>
        <button class="btn" style="width: 100%; margin-bottom: 20px;" onclick="app.ui.toggleTheme()">üåì –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É</button>
        
        <label style="font-weight: bold; margin-bottom: 5px; display: block;">–û—Å–Ω–æ–≤–Ω–∞—è –≤–∞–ª—é—Ç–∞:</label>
        <select id="currency-select" onchange="app.settings.setCurrency(this.value)">
            <option value="USD">–î–æ–ª–ª–∞—Ä ($)</option>
            <option value="EUR">–ï–≤—Ä–æ (‚Ç¨)</option>
            <option value="RUB">–†—É–±–ª—å (‚ÇΩ)</option>
            <option value="GEL">–õ–∞—Ä–∏ (‚Çæ)</option>
        </select>
        <p style="font-size: 0.8rem; color: var(--text-sec)">–í—Å–µ —Å—É–º–º—ã –±—É–¥—É—Ç –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω—ã –ø–æ —Ç–µ–∫—É—â–µ–º—É –∫—É—Ä—Å—É.</p>
        
        <br>
        <button class="btn" style="width: 100%; color: var(--danger)" onclick="app.data.reset()">‚ö†Ô∏è –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
        <br><br>
        <button class="btn btn-primary" style="width: 100%" onclick="document.getElementById('settings-modal').style.display='none'">–ì–æ—Ç–æ–≤–æ</button>
    </div>
</div>

<script>
const app = {
    // –î–∞–Ω–Ω—ã–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    state: {
        finances: [], // {id, date, amount, type, category, currency}
        tasks: {}, // 'YYYY-MM-DD': [{id, text, cat, points, done, subtasks:[]}]
        settings: { theme: 'light', currency: 'USD' }
    },
    
    // –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç (–±–∞–∑–∞ - USD)
    rates: {
        'USD': 1,
        'EUR': 0.92,
        'GEL': 2.75,
        'RUB': 90.0
    },
    
    symbols: { 'USD': '$', 'EUR': '‚Ç¨', 'GEL': '‚Çæ', 'RUB': '‚ÇΩ' },
    
    currentDate: new Date().toISOString().split('T')[0],

    init() {
        this.data.load();
        this.ui.applyTheme();
        this.settings.initCurrency();
        this.tasks.render();
        this.stats.refresh();
        this.finance.renderHistory();
    },

    // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–ú–ò ---
    data: {
        load() {
            const d = localStorage.getItem('teplo_v3');
            if(d) app.state = {...app.state, ...JSON.parse(d)};
        },
        save() {
            localStorage.setItem('teplo_v3', JSON.stringify(app.state));
            app.stats.refresh(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –ª—é–±–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
        },
        reset() {
            if(confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å—ë?')) {
                localStorage.removeItem('teplo_v3');
                location.reload();
            }
        }
    },

    // --- –í–ê–õ–Æ–¢–ê –ò –ù–ê–°–¢–†–û–ô–ö–ò ---
    settings: {
        initCurrency() {
            document.getElementById('currency-select').value = app.state.settings.currency;
            this.updateSymbols();
        },
        setCurrency(curr) {
            app.state.settings.currency = curr;
            app.data.save();
            this.updateSymbols();
            app.stats.refresh();
            app.finance.renderHistory();
        },
        updateSymbols() {
            const sym = app.symbols[app.state.settings.currency];
            document.querySelectorAll('.currency-symbol').forEach(el => el.innerText = sym);
        },
        // –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä: –õ—é–±–∞—è -> USD -> –¶–µ–ª–µ–≤–∞—è
        convert(amount, fromCurr) {
            const target = app.state.settings.currency;
            if (fromCurr === target) return amount;
            
            const inUSD = amount / app.rates[fromCurr]; // –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ –±–∞–∑—É
            return inUSD * app.rates[target]; // –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ —Ü–µ–ª–µ–≤—É—é
        }
    },

    // --- –ó–ê–î–ê–ß–ò ---
    tasks: {
        viewDate: new Date().toISOString().split('T')[0],

        add() {
            const text = document.getElementById('new-task-text').value;
            if(!text) return;
            const cat = document.getElementById('new-task-cat').value;
            
            const pointsMap = {'–†–∞–±–æ—Ç–∞':10, '–¢–µ–ª–æ':5, '–§–æ–∫—É—Å':5, '–ë—ã—Ç':2};
            
            if(!app.state.tasks[this.viewDate]) app.state.tasks[this.viewDate] = [];
            
            app.state.tasks[this.viewDate].push({
                id: Date.now(),
                text, cat, 
                points: pointsMap[cat],
                done: false,
                subtasks: []
            });
            
            document.getElementById('new-task-text').value = '';
            app.data.save();
            this.render();
        },

        toggle(id) {
            const list = app.state.tasks[this.viewDate];
            const t = list.find(x => x.id === id);
            if(t) {
                t.done = !t.done;
                // –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –≤—Å–µ –ø–æ–¥–∑–∞–¥–∞—á–∏ —Ç–æ–∂–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ –ª–æ–≥–∏—á–Ω–æ)
                // –ò–ª–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å. –ó–¥–µ—Å—å –ª—É—á—à–µ –æ—Å—Ç–∞–≤–∏—Ç—å: –≥–∞–ª–æ—á–∫–∞ –∑–∞–¥–∞—á–∏ –≥–ª–∞–≤–Ω–µ–µ.
                app.data.save();
                this.render();
            }
        },

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∑–∞–¥–∞—á–∞–º–∏
        toggleSubMenu(e, id) {
            e.stopPropagation(); // –ß—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª –∫–ª–∏–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É
            const el = document.getElementById('subs-'+id);
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
        },

        addSubtask(e, id) {
            e.stopPropagation();
            const text = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–∑–∞–¥–∞—á–∏:');
            if(!text) return;
            const t = app.state.tasks[this.viewDate].find(x => x.id === id);
            t.subtasks.push({text, done: false});
            // –†–∞—Å–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–µ
            setTimeout(() => document.getElementById('subs-'+id).style.display = 'block', 50);
            app.data.save();
            this.render();
        },

        checkSubtask(e, taskId, subIdx) {
            e.stopPropagation(); // –í–ê–ñ–ù–û: –Ω–µ —Å–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å –º–µ–Ω—é
            const t = app.state.tasks[this.viewDate].find(x => x.id === taskId);
            t.subtasks[subIdx].done = !t.subtasks[subIdx].done;
            
            // –õ–æ–≥–∏–∫–∞: –µ—Å–ª–∏ –≤—Å–µ –ø–æ–¥–∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã -> –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≥–ª–∞–≤–Ω—É—é
            const allDone = t.subtasks.length > 0 && t.subtasks.every(s => s.done);
            if (allDone) t.done = true;
            else t.done = false;

            app.data.save();
            this.render();
            // –î–µ—Ä–∂–∏–º –º–µ–Ω—é –æ—Ç–∫—Ä—ã—Ç—ã–º
            document.getElementById('subs-'+taskId).style.display = 'block';
        },

        changeDay(d) {
            const date = new Date(this.viewDate);
            date.setDate(date.getDate() + d);
            this.viewDate = date.toISOString().split('T')[0];
            this.render();
        },

        render() {
            document.getElementById('current-date-display').innerText = 
                this.viewDate === app.currentDate ? '–°–µ–≥–æ–¥–Ω—è' : this.viewDate;
            
            const list = document.getElementById('tasks-list');
            list.innerHTML = '';
            const tasks = app.state.tasks[this.viewDate] || [];

            tasks.forEach(t => {
                const isDone = t.done;
                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –ø–æ–¥–∑–∞–¥–∞—á
                let subsHtml = '';
                t.subtasks.forEach((s, idx) => {
                    subsHtml += `
                        <div class="subtask-item" onclick="event.stopPropagation()">
                            <input type="checkbox" ${s.done?'checked':''} onchange="app.tasks.checkSubtask(event, ${t.id}, ${idx})" style="width:20px; height:20px; margin:0 10px 0 0;">
                            <span style="text-decoration:${s.done?'line-through':''}">${s.text}</span>
                        </div>
                    `;
                });

                const div = document.createElement('div');
                div.className = 'task-card';
                div.style.borderLeftColor = isDone ? 'var(--success)' : 'var(--primary)';
                div.innerHTML = `
                    <div class="task-header" onclick="app.tasks.toggleSubMenu(event, ${t.id})">
                        <div style="display:flex; align-items:center; flex:1;">
                            <input type="checkbox" ${isDone?'checked':''} onclick="event.stopPropagation(); app.tasks.toggle(${t.id})" style="width:24px; height:24px; margin:0;">
                            <span class="task-title ${isDone?'task-done-text':''}">${t.text}</span>
                        </div>
                        <div style="font-size:0.8rem; background:rgba(0,0,0,0.05); padding:5px 10px; border-radius:10px;">${t.points}–±</div>
                    </div>
                    <div id="subs-${t.id}" class="subtasks-container">
                        ${subsHtml}
                        <button class="btn" style="margin-top:10px; width:100%; font-size:0.8rem;" onclick="app.tasks.addSubtask(event, ${t.id})">+ –ü–æ–¥–∑–∞–¥–∞—á–∞</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }
    },

    // --- –§–ò–ù–ê–ù–°–´ ---
    finance: {
        add(type) {
            const amtEl = document.getElementById(type==='income'?'inc-amount':'exp-amount');
            const catEl = document.getElementById(type==='income'?'inc-cat':'exp-cat');
            
            const amount = parseFloat(amtEl.value);
            if(!amount) return;

            app.state.finances.push({
                id: Date.now(),
                date: app.currentDate,
                amount,
                type,
                category: catEl.value,
                currency: app.state.settings.currency // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∞–ª—é—Ç—É, –≤ –∫–æ—Ç–æ—Ä–æ–π –±—ã–ª–∞ –∑–∞–ø–∏—Å—å
            });

            amtEl.value = '';
            app.data.save();
            this.renderHistory();
            alert('–ó–∞–ø–∏—Å–∞–Ω–æ!');
        },

        renderHistory() {
            const render = (type, containerId) => {
                const cont = document.getElementById(containerId);
                cont.innerHTML = '';
                // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞–ø–∏—Å–µ–π —ç—Ç–æ–≥–æ —Ç–∏–ø–∞
                const list = app.state.finances.filter(f => f.type === type).reverse().slice(0, 10);
                
                list.forEach(f => {
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —Ç–µ–∫—É—â—É—é –≤–∞–ª—é—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    const displayAmt = app.settings.convert(f.amount, f.currency).toFixed(0);
                    const sym = app.symbols[app.state.settings.currency];
                    
                    const div = document.createElement('div');
                    div.style.cssText = "display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid rgba(0,0,0,0.05);";
                    div.innerHTML = `
                        <span>${f.category} <small style="color:var(--text-sec)">${f.date.slice(5)}</small></span>
                        <span style="font-weight:bold">${displayAmt} ${sym}</span>
                    `;
                    cont.appendChild(div);
                });
            };
            render('income', 'income-history');
            render('expense', 'expense-history');
        }
    },

    // --- –°–¢–ê–¢–ò–°–¢–ò–ö–ê ---
    stats: {
        period: 'today',
        
        setPeriod(p, btn) {
            this.period = p;
            document.querySelectorAll('.date-filters .btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active'); // –§–∏–∫—Å: –µ—Å–ª–∏ –≤—ã–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ, btn –º–æ–∂–µ—Ç –±—ã—Ç—å null
            
            const map = {'today': '–°–µ–≥–æ–¥–Ω—è', 'week': '–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π', 'month': '–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π'};
            document.getElementById('stats-period-label').innerText = map[p];
            
            this.refresh();
        },

        refresh() {
            // 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—ã
            const dates = [];
            const today = new Date();
            const daysCount = this.period === 'today' ? 1 : (this.period === 'week' ? 7 : 30);
            
            for(let i = daysCount - 1; i >= 0; i--) {
                const d = new Date();
                d.setDate(today.getDate() - i);
                dates.push(d.toISOString().split('T')[0]);
            }

            // 2. –°—á–∏—Ç–∞–µ–º –§–∏–Ω–∞–Ω—Å—ã –∏ –ë–∞–ª–ª—ã
            let totalInc = 0, totalExp = 0, totalPoints = 0;
            const chartData = dates.map(date => {
                // –§–∏–Ω–∞–Ω—Å—ã
                const dayFins = app.state.finances.filter(f => f.date === date);
                let dInc = 0, dExp = 0;
                
                dayFins.forEach(f => {
                    const val = app.settings.convert(f.amount, f.currency);
                    if(f.type === 'income') dInc += val;
                    else dExp += val;
                });
                
                totalInc += dInc;
                totalExp += dExp;

                // –ë–∞–ª–ª—ã
                const dayTasks = app.state.tasks[date] || [];
                // –ë–µ—Ä–µ–º –±–∞–ª–ª—ã, –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
                const dPoints = dayTasks.filter(t => t.done).reduce((sum, t) => sum + t.points, 0);
                totalPoints += dPoints;

                return { date: date.slice(8), inc: dInc, exp: dExp, points: dPoints };
            });

            // 3. –†–µ–Ω–¥–µ—Ä UI –¢–µ–∫—Å—Ç–æ–≤
            document.getElementById('total-inc').innerText = totalInc.toFixed(0);
            document.getElementById('total-exp').innerText = totalExp.toFixed(0);
            document.getElementById('total-points').innerText = totalPoints;
            
            // –†–µ–Ω–¥–µ—Ä –°—Ç—Ä–∏–∫–∞
            this.calculateStreak();

            // 4. –†–µ–Ω–¥–µ—Ä –ì—Ä–∞—Ñ–∏–∫–æ–≤
            this.renderChart('finance-chart', chartData, ['inc', 'exp']);
            this.renderChart('energy-chart', chartData, ['points']);
        },

        calculateStreak() {
            // –°—á–∏—Ç–∞–µ–º —Å—Ç—Ä–∏–∫: —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ –Ω–∞–∑–∞–¥ (–Ω–∞—á–∏–Ω–∞—è —Å–æ –≤—á–µ—Ä–∞) –±—ã–ª–∏ –±–∞–ª–ª—ã > 0
            // –ò–ª–∏ –µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è —É–∂–µ –µ—Å—Ç—å –±–∞–ª–ª—ã, —Ç–æ –≤–∫–ª—é—á–∞—è —Å–µ–≥–æ–¥–Ω—è
            let streak = 0;
            const d = new Date();
            // –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å "–°–µ–≥–æ–¥–Ω—è"
            
            while(true) {
                const dateStr = d.toISOString().split('T')[0];
                const tasks = app.state.tasks[dateStr] || [];
                const points = tasks.filter(t => t.done).reduce((a,b)=>a+b.points,0);
                
                // –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –±–∞–ª–ª–æ–≤ 0, –∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –ø—Ä–æ–≤–µ—Ä–∫–∏ - –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º, —Å–º–æ—Ç—Ä–∏–º –≤—á–µ—Ä–∞
                // –ù–æ –µ—Å–ª–∏ —ç—Ç–æ –≤—á–µ—Ä–∞ –∏ –±–∞–ª–ª–æ–≤ 0 - –ø—Ä–µ—Ä—ã–≤–∞–µ–º
                
                // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: —Å—Ç—Ä–∏–∫ —ç—Ç–æ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è —Å–µ—Ä–∏—è –¥–Ω–µ–π –° –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏.
                // –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è 0, –Ω–æ –≤—á–µ—Ä–∞ –±—ã–ª–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ - —Å—Ç—Ä–∏–∫ –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –≤–∏–∑—É–∞–ª—å–Ω–æ –ø–æ–∫–∞ –¥–µ–Ω—å –Ω–µ –ø—Ä–æ—à–µ–ª.
                // –ë—É–¥–µ–º —Å—á–∏—Ç–∞—Ç—å "—á–∏—Å—Ç—ã–π" —Å—Ç—Ä–∏–∫ –Ω–∞–∑–∞–¥.
                
                if (points > 0) {
                    streak++;
                } else {
                    // –ï—Å–ª–∏ –±–∞–ª–ª–æ–≤ –Ω–µ—Ç, –∏ —ç—Ç–æ –Ω–µ —Å–µ–≥–æ–¥–Ω—è (—Ç.–µ. –¥–µ–Ω—å –≤ –ø—Ä–æ—à–ª–æ–º –ø—Ä–æ–ø—É—â–µ–Ω) -> –∫–æ–Ω–µ—Ü —Å—Ç—Ä–∏–∫–∞
                    if (dateStr !== app.currentDate) break;
                }
                d.setDate(d.getDate() - 1);
                // –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏
                if (streak > 3650) break; 
            }
            document.getElementById('streak-count').innerText = streak;
        },

        renderChart(id, data, keys) {
            const el = document.getElementById(id);
            el.innerHTML = '';
            
            // –ù–∞–π—Ç–∏ –º–∞–∫—Å –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∞
            let max = 10;
            data.forEach(d => {
                if(keys.includes('points')) max = Math.max(max, d.points);
                else max = Math.max(max, d.inc, d.exp);
            });

            data.forEach(d => {
                const col = document.createElement('div');
                col.className = 'bar-col';
                
                if(keys.includes('points')) {
                    const h = (d.points / max) * 100;
                    col.innerHTML = `<div class="bar" style="height:${h}%; background:var(--primary)"></div>`;
                } else {
                    // –§–∏–Ω–∞–Ω—Å—ã (2 –±–∞—Ä–∞ —Ä—è–¥–æ–º –∏–ª–∏ –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–µ, —Ç—É—Ç —Å–¥–µ–ª–∞–µ–º —Ä—è–¥–æ–º —É–ø—Ä–æ—â–µ–Ω–Ω–æ –∏–ª–∏ –Ω–∞–ª–æ–∂–µ–Ω–∏–µ)
                    // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã - 2 —Ç–æ–Ω–∫–∏—Ö –ø–æ–ª–æ—Å–∫–∏ –≤–Ω—É—Ç—Ä–∏ col –Ω–µ –≤–ª–µ–∑–µ—Ç –∫—Ä–∞—Å–∏–≤–æ –±–µ–∑ —à–∏—Ä–∏–Ω—ã
                    // –°–¥–µ–ª–∞–µ–º: –µ—Å–ª–∏ –¥–æ—Ö–æ–¥ –±–æ–ª—å—à–µ —Ä–∞—Å—Ö–æ–¥–∞ - –∑–µ–ª–µ–Ω—ã–π –±–∞—Ä, –µ—Å–ª–∏ —Ä–∞—Å—Ö–æ–¥ –±–æ–ª—å—à–µ - –∫—Ä–∞—Å–Ω—ã–π, –≤—ã—Å–æ—Ç–∞ –ø–æ –º–∞–∫—Å
                    // –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ 2 –±–∞—Ä–∞ –∞–±—Å–æ–ª—é—Ç–æ–º. –°–¥–µ–ª–∞–µ–º "–°—Ç–µ–∫"
                    
                    const hInc = (d.inc / max) * 100;
                    const hExp = (d.exp / max) * 100;
                    
                    // –†–∏—Å—É–µ–º –¥–≤–∞ –±–∞—Ä–∞ —Ä—è–¥–æ–º –≤–Ω—É—Ç—Ä–∏ –∫–æ–ª–æ–Ω–∫–∏
                    col.innerHTML = `
                        <div style="display:flex; align-items:flex-end; width:100%; height:100%; gap:2px;">
                            <div class="bar" style="height:${hInc}%; background:var(--success); width:50%"></div>
                            <div class="bar" style="height:${hExp}%; background:var(--danger); width:50%"></div>
                        </div>
                    `;
                }
                
                col.innerHTML += `<div class="bar-label">${d.date}</div>`;
                el.appendChild(col);
            });
        }
    },

    ui: {
        switchTab(tab, btn) {
            document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            btn.classList.add('active');

            if(tab === 'stats') app.stats.refresh();
        },
        toggleTheme() {
            app.state.settings.theme = app.state.settings.theme === 'light' ? 'dark' : 'light';
            this.applyTheme();
            app.data.save();
        },
        applyTheme() {
            document.body.setAttribute('data-theme', app.state.settings.theme);
        },
        toggleModal(id) {
            const el = document.getElementById(id);
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
        }
    }
};

window.onload = () => app.init();
</script>
</body>
</html>
